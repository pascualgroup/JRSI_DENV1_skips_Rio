---
title: "Supporting Information: Implementation of Stochastic SIR Cosine Model"
author: "Rahul Subramanian"
date: "March 23, 2020"
output:
  html_document: 
    toc: true
    toc_float: true
  pdf_document: default
---

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{float}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
```

# Set up baseline model

##Load Non-POMP Libraries and Files
```{r echo = TRUE, results = 'hide', warning=FALSE}
rm(list = ls())
source("load_libraries_essential.R")
source("rahul_theme.R")
```

##Load POMP2
```{r}
library(pomp)
```
We consider fitting a simple SEIR spline model to monthly case counts of DENV1 incidence in the municipality of Rio de Janeiro from April 1,1986 to December 31, 1987. The data consist of monthly case counts that are reported each week and then aggregated by month. The dates correspond to notification dates, not date of disease onset. For example, if 535 cases were reported for April 1986, it means that 535 cases were observed between April 1st,1986-April 30th,1986.

## Declare model name
```{r}
full_model_name = "DENV1_SIR_Cosine_2_25_Year_Split_Fit_No_Immigration_Fix_R_Init_Fix_Duration_No_Sigma_P_Movement"
model_name = "A_7"
rds_index = 0


```


## Load dengue case data
```{r}
load(file ="../Down_Data/denguerj1986-1996.RData")
#head(dengue.ts)
```

## Clean up data into correct time scale for POMP object
```{r}
library(zoo)
library(pomp)
Rio_city_DENV1_clean = data.frame(Y = as.matrix(dengue.ts),
                                  Date = as.Date(as.yearmon(time(dengue.ts))))
Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date >= "1986-05-01")

head(Rio_city_DENV1_clean)
add_a_month = Rio_city_DENV1_clean$Date %m+% months(1)
#add_a_week = Rio_city_DENV1_clean$Date %m+% weeks(1)
#last_day_of_month = add_a_month - 1
correct_date_in_days_since_Jan_1_1986 = add_a_month - as.Date("1986/01/01")


Rio_data_clean = data.frame(times = as.numeric(correct_date_in_days_since_Jan_1_1986),
                            Y = Rio_city_DENV1_clean$Y)
#Only use first two years of data (April  1, 1986 - December 1, 1987)
Rio_data_clean = filter(Rio_data_clean, times <= 365*2.50)
write.csv(Rio_data_clean,
     file = "../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv", row.names = FALSE)
#head(Rio_data_clean)


```

### Set $t0$
```{r}
t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01"))
```


## Source Csnippets
```{r, echo=FALSE}
source("Csnippet_SIR_cosine_model.R")
```

```{r, cache=FALSE}

knitr::read_chunk('Csnippet_SIR_cosine_model.R')
```

## Define covariate time range
```{r covar_time_names}

```

The SIR model has three states, Susceptible, Infected, and Recovered:


```{r statenames}

```

\pagebreak

\begin{table}[]
\centering
\caption{State Variables and Covariates}
\begin{tabular}{l|c|r}
\hline
Term & Definition & Type \\\hline
$S(t)$ & Susceptible humans in city $i$  & State Variable  \\\hline
$I(t)$ & Infected humans in city $i$ & State Variable\\\hline
$R(t)$ & Recovered humans in city $i$ & State Variable\\\hline
$C(t)$ & Reported Human Cases & State Variable \\\hline
$N(t)$ &  Human Population & State Variable \\\hline
 \end{tabular}
\end{table}


```{r}

```

## Parameters
The force of infection $\lambda(t)$ is a function of the infected immigration rate $\epsilon$ and overall transmission rate $\beta(t)$ which in turn is assumed to be a  cosine function of time $t$ with mean $\beta_0$, amplitude $\delta$, frequency $\omega$ and phase $\phi$   which will be fit along with a gamma-distributed white noise parameter $\frac{d\Gamma}{dt}$. $\omega$ is fixed at an annual frequency ($\omega = \frac{2 \pi}{365}$).

The white noise $\frac{d\Gamma}{dt}$ is drawn from a gamma distribution with intensity $\sigma = \sigma_{\text{P}}$ and duration of Euler step $dt = \Delta$, where $\Delta$ is the simulation time step of two hours (or $\frac{1}{12}$ in units of days). The intensity parameter $\sigma_{\text{P}}$ will be fit to the data.

## Environmental Noise Intensity
The discretization of the Gamma-distributed environmental noise in the model has the form:

\begin{equation}
\Delta \Gamma \sim rgammawn(\mu = dt, \sigma =  \sigma_{\text{P}})
\end{equation}

Formally, this is equivalent to a draw from a Gamma-distribution with shape parameter $\alpha = \frac{\delta}{\sigma_{\text{P}}^2}$ and scale parameter $\beta = \frac{1}{\sigma_{\text{P}}^2}$. (Note that $\delta = \Delta t$, and for all of this sub-section $\beta$ refers to the Gamma distribution scale parameter rather than the transmission rate function, which is reffered to as $\beta (t)$).

\begin{equation}
\Delta \Gamma \sim \Gamma (\frac{\delta}{\sigma_{\text{P}}^2}, \frac{1}{\sigma_{\text{P}}^2})
\end{equation}


## Population and Reporting

We started the model with the estimated resident population of the municipality of Rio de Janeiro in 1991 according to the 1991 census. This estimated population is $N = 5 480 768$.
The estimate was obtained from the IBGE's "Censo Demographico- 1991-Rio de Janeiro". The full description of the document in the IBGE catalog is "Censo demográfico : 1991 : resultados do universo relativos as características da população e dos domicílios"

The document can be accessed at the following site on the IBGE catalog:
https://biblioteca.ibge.gov.br/biblioteca-catalogo?id=782&view=detalhes

At that site, the name of the file (which can be downloaded) is:
cd_1991_n20_caracteristicas_populacao_domicilios_rj.pdf

In this document, the population estimate was found under Table 1.4: "População residente, por grupos de idade, segundo tU lolesorregiàes, as Microrregiões, os Municípios,os Distritos e o sexo"

The sub-section of the table (the sub-heading can be found on page 27 of the document (page 32 using the document's internal pagination)) was "Municipios e Distritos"

The population estimate for the municipality of Rio de Janeiro can be found on page 36 of that document (page 41 using internal pagination) under the row "Rio de Janeiro" and column heading "Total".

The population estimate again was $N = 5 480 768$


We next obtained the estimated resident pouplation of the municipality of Rio de Janeiro in 2000 using the 2000 census from the IBGE website.

We obtained estimates of the resident population of the municipality of Rio de Janeiro in 2000 from the 200 Brazil census (specific table page: https://ww2.ibge.gov.br/home/estatistica/populacao/censo2000/universo.php?tipo=31o/tabela13_1.shtm&paginaatual=1&uf=33&letra=R).

Census website: https://ww2.ibge.gov.br/english/estatistica/populacao/censo2000/default.shtm

Heading Type: População residente, sexo e situação do domicílio; Total column

Estimated Population of Rio de Janeiro in 2000: 5,857,904

Estimated Population of Rio de Janeiro in 2010 (for reference): 6,320,446 (based on the 2010 population
estimate of the municipality of Rio de Janeiro from Table 1378 of the 2010 Brazilian census (accessed at https://sidra.ibge.gov.br/tabela/1378 ; original website https://sidra.ibge.gov.br/pesquisa/censo-demografico/demografico-2010/universo-caracteristicas-da-populacao-e-dos-domicilios ))

We calculate the rate of human population growth from 1991 to 2000 assuming exponential growth. We will then use this rate to back-calculate an estimate of the muncipal resident population size in 1986 (again assuming exponential population growth).

### Pop growth rate calculation
```{r}
Population_Rio_2000 = 5857904 #Census
Population_Rio_1991 = 5480768# Census:
Two_hour_segments_in_year = 365 * 12
time_between_census_dates = 2000*365 - 1991*365
human_pop_growth_rate = (1 / time_between_census_dates) *
  log(Population_Rio_2000 / Population_Rio_1991)
human_pop_growth_rate

```

### Back-calculation of 1986 Population
```{r}
time_before_1991_census_dates = 1991*365 - 1986*365
Population_Rio_1986 = Population_Rio_1991/(exp(human_pop_growth_rate*time_before_1991_census_dates))
```

Thus, the estimated pouplation fo Rio de Janeiro is approximately $N_0 = 5281842$



This version of the model assumes a constant population size with demographic turnover $\mu$ given by the inverse of the life expectancy of Brazil in 2012 (74.49 years https://censo2010.ibge.gov.br/en/noticias-censo.html?busca=1&id=1&idnoticia=2528&t=life-expectancy-at-birth-was-74-6-years-in-2012&view=noticia ).

A fraction $\rho$ of newly infected cases are reported and enter the reported case category $C$.  We will be fitting the reporting rate.

The observed monthly cases are assumed to have a negative binomial distribution with mean equal to the true number of monthly cases and size parameter equal to $\frac{1}{\sigma_{\text{M}}^2}$, where $\sigma_{\text{M}}$ will be fit to the data. 

We assume a duration of infection ($\frac{1}{\gamma}$) of
10.25 days. Dengue is believed to have a symptomatic period of 2-7 days following an  incubation period of 4-7 days, which we have combined in our model into a single infectious period. (http://www.who.int/news-room/fact-sheets/detail/dengue-and-severe-dengue)



The model framework contains the parameterization necessary to incorporate population growth.

Let $r$ represent the per capita rate at which new individuals enter the population, while $\mu_{\text{H}}$ is the death rate. Let $h$ represent the per capita growth rate of the population (i.e. $h = r − \mu_{\text{H}}$). We assume that the net
population growth rate is exponential:

\begin{equation}
\frac{dN}{dt} = h N(t)
\end{equation}

Let  $r$ represent the overall growth rate of the susceptible population taking into account both populato, where
\begin{equation}
    r = h + \mu_{\text{H}}
\end{equation}
at rate $h$. Population growth would then occur at rate:



In this instance, we assume that $h = 0$.


## Process Model



###  ODE Equations with only Environmental Noise
\begin{equation}
\beta(t) = \beta_0 (1 + \delta sin(\omega t + \phi));
\end{equation}

\begin{equation}
\frac{d\Gamma}{dt} \sim\  rgammawn(\sigma_{\text{P}}, \Delta t)
\end{equation}

\begin{equation}
\lambda(t) = \beta(t)(\frac{I(t) + \epsilon}{N})\frac{d\gamma}{dt}
\end{equation}

\begin{equation}
    \frac{dS}{dt} = r N + - \lambda(t) S(t)-\mu_{\text{H}} S(t)
\end{equation}

\begin{equation}
    \frac{dI}{dt} =  \lambda(t) S(t) -\gamma I(t) - \mu_{\text{H}}I(t)
\end{equation}

\begin{equation}
    \frac{dR}{dt} = \gamma I(t) - \mu_{\text{H}}R(t)
\end{equation}

Cases $C$ are summed over each month. 


The expression for $\frac{dS}{dt}$ can be further specified into separate terms for the net population growth and replacement of deaths. 

\begin{equation}
    \frac{dS}{dt} = h N + \mu_{\text{H}}N + - \lambda(t) S(t)-\mu_{\text{H}} S(t)
\end{equation}

###   Equations for model with demographic and environmental noise

Rates in continuous time:

\begin{equation}
 \mu_{SI}(t) = \beta (\frac{ I(t) + \epsilon}{ N(t)})
\end{equation}

\begin{equation}
 \mu_{IR}(t) = \gamma
\end{equation}

Let $\mu_{\cdot N}$ represent the rate of net population growth. 

\begin{equation}
 \mu_{\cdot N} = h
\end{equation}

Let $\mu_{\cdot S}$ represent the rate at which indiduals who die are replaced by susceptible individuals. We assume that this replacement rate is equivalent to the death rate. 

\begin{equation}
 \mu_{\cdot S} = \mu_{H}
\end{equation}

\begin{equation}
 \mu_{S\cdot} =   \mu_{I \cdot} = \mu_{R \cdot} =  \mu_{H}
\end{equation}

### Discretizations

#### Discretization of poupulation growth

\begin{equation}
  \Delta \tilde N_{\cdot N} \sim  Binomial (\tilde N(t),  1 - e^{-\tilde \mu_{\cdot N} \Delta t })
\end{equation}

Discretization of Gamma white noise from time $t$ to $t + \Delta t$
\begin{equation}
\Delta \Gamma  \sim\  rgammawn(\sigma_{\text{P}}, \Delta t)
\end{equation}

Discretization of force of infection from time $t$ to $t + \Delta t$
\begin{equation}
\tilde \lambda(t) = \mu_{SI}(t) \Delta \Gamma
\end{equation}

Discretization of compartment flows from time $t$ to  time $t + \Delta t$
\begin{equation}
  \Delta \tilde N_{SI} \sim  Binomial (\tilde S(t), 1 - e^{- \tilde \lambda(t) } )
\end{equation}

\begin{equation}
  \Delta \tilde N_{IR} \sim  Binomial (\tilde I(t), 1 - e^{- \tilde \mu_{IR}(t)  \Delta t } )
\end{equation}

\begin{equation}
  \Delta \tilde N_{\cdot S} \sim  Binomial (\tilde N(t),  1 - e^{-\tilde \mu_{\cdot S}(t)  \Delta t })
\end{equation}

\begin{equation}
  \Delta \tilde N_{S \cdot } \sim  Binomial (\tilde S(t), 1 - e^{- \tilde \mu_{S \cdot }(t)  \Delta t} )
\end{equation}

\begin{equation}
  \Delta \tilde N_{I \cdot } \sim  Binomial (\tilde I(t), 1 - e^{- \tilde \mu_{I \cdot }(t)  \Delta t } )
\end{equation}

\begin{equation}
  \Delta \tilde N_{R \cdot } \sim  Binomial (\tilde R(t), 1 - e^{- \tilde \mu_{R \cdot }(t)  \Delta t} )
\end{equation}

\begin{equation}
  \Delta \tilde S =  \Delta \tilde N_{\cdot N} + \Delta \tilde N_{\cdot S}- \Delta \tilde N_{SI} - \Delta \tilde N_{S \cdot}
\end{equation}

\begin{equation}
  \Delta \tilde I = \Delta \tilde N_{SI}- \Delta \tilde N_{IR} - \Delta \tilde N_{I \cdot}
\end{equation}

\begin{equation}
  \Delta \tilde R = \Delta \tilde N_{IR} - \Delta \tilde N_{R \cdot}
\end{equation}

\begin{equation}
  \Delta \tilde N = \Delta \tilde N_{\cdot N} + \Delta \tilde N_{\cdot S}  - \Delta \tilde N_{S \cdot}  - \Delta \tilde N_{I \cdot}  -
  \Delta \tilde N_{R \cdot}
\end{equation}

We note several notational differences between the written equations and the R implementation. First, the variable descirbed as $h$ in the writeup is instead denoted by $r$. The variable $r$ in the writeup is not explicityly reffered to in the code in this document. Secondly, the variable $\Delta \tilde N_{\cdot N}$ is written as $dBS_N$ in the code while the variable $\Delta \tilde N_{\cdot S}$ in the writeup is written as $dBS$.

```{r rproc}

```
## Measurement Model

\begin{equation}
Y \sim\ NBinom(size = 1/(\sigma_{\text{M}})^2,\mu = C)
\end{equation}
```{r rmeas}

```

```{r dmeas}

```

## Initial Conditions
\pagebreak
We assume that a small fraction of the population $I_0$ starts out infected, but that everyone else is susceptible at the start of the DENV1 invasion.
\begin{table}[]
\centering
\begin{tabular}{l|c|c|r}
Term & Definition & Value & Units \\\hline

 $C_{\text{0}}$ & Monthly reported cases at start
 of human invasion&  0 (Ignored) & $\text{person}$\\

  $I_{\text{0}}$ & Infected people at start of human invasion
 & Fit & $\text{person}$\\

 $S_{\text{0}}$ & Susceptible people at start of human invasion in city $i$
 & $N - I_{\text{Init}}$& $\text{person}$\\

   $R_{\text{0}}$ & Recovered people at start of human sim in city $i$
 & Fit & $\text{person}$\\


\end{tabular}
\caption{Initial Conditions. }
\end{table}


```{r init}

```

## Parameter Transforms
```{r par_trans}

```



## Covariates
```{r covar}

```

## MIF Function Call from Parallelized Midway Script
Function to run single MIF run for given number of iterations followed by 10 Pfilter runs from final MIF values
```{r MIF_and_pfilter_output_function}

```


# Generate profiles
I generated profiles for eleven model parameters: $\beta_0$, $\delta$, $E_\text{0}$, $I_\text{0}$, $\rho$, $\mu_{\text{EI}}$, $\gamma$ $\phi$, $N_0$, $\sigma_{\text{M}}$, and $\sigma_{\text{P}}$.

## Generate set of parameter combinations for profiles

The profileDesign function was used to generate a set of starting points at 30 different evenly spaced values for the parameter being profiled. For each profile parameter value, the function created 40 different initial sampling points drawing from a box given by the boundaries of the original parameter range  defined in the beginning. For example, for the $I_\text{0}$ profile,  a set of 30 starting points evenly spaced between 1 and 10,000 was generated. For each of those 30 starting points, the profileDesign function created 40 different initial sampling points with the same value of $I_\text{0}$ but different values for the other parameters being fitted ($\beta_0$, $\delta$, $E_\text{0}$, $\mu_{\text{EI}}$, $\gamma$ $\phi$, , $\sigma_{\text{M}}$, and $\sigma_{\text{P}}$) where the different values were uniformly drawn from the boundaries for those parameters in the original box. This yielded a total of 1200 starting points for each parameter profile. 





```{r, cache=FALSE}

knitr::read_chunk('generate_profile_combinations_SIR_Cosine.R')
```

```{r generate_profile_combinataions, eval = FALSE, echo = TRUE}

```

## Midway code for running MIF on each subset of parameter combinations
For each of those 1200 starting points, MIF was run 10 times.

Since this is a large number of iterations, two different parallelization strategies were employed at once on the University of Chicago's Research Computing Center's Midway cluster. First, multiple cores (28) were requested per job and a foreach loop was
used to parallelize a single job between multiple cores on the cluster. However, if  a large amount of cores are requested for a job, the Midway scheduler will wait until sufficient resources are available on the cluster, which can create a long lag time. To remedy this, the overall job was split into 50 array jobs (the maximum number of jobs that can be submitted to or running on the Midway cluster at any point in time). Each of those 50 array jobs in turn was parallelized over 28 cores.

```{r, cache=FALSE}

knitr::read_chunk('MIF_run_Model_A_7.R')
```
The R code below  was run on Midway for each of 50 array jobs.


```{r mif_code, eval = FALSE, echo = TRUE}

```


### Midway script code
#### $I_{\text{0}}$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_I_0_Profile.sbatch

```

#### $\beta_0$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_Beta_0_Profile.sbatch

```


#### $\sigma_{\text{P}}$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_sigma_P_Profile.sbatch

```

#### $\sigma_{\text{M}}$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_sigma_M_Profile.sbatch

```


#### $\rho$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_rho_Profile.sbatch

```

#### $\phi$ Profile script
```{r engine='bash', comment=''}

cat Midway_script_Model_A_7_phi_Profile.sbatch

```

## Combine Midway output susbsets
Once all of the 50 array jobs submitted to Midway for a particular profile have finished running on the cluster, the output from each of those 50 jobs is combined into one data frame  with combinations and likelihoods for a particular profile.


```{r}

  # ---- combine_profile_output ----


# Header ------------------------------------------------------------------
## Name: combine_profile_output.R
## Author: Rahul Subramanian
## Description: Combine MIF real profile output data into one big data frame

  combine_profile_output = function(profile_var, model_name){


ptm = proc.time()


#profile_var = "I_0"
#args = commandArgs(trailingOnly=TRUE)

#profile_var = as.character(args[1])
print(profile_var)

###Load parameter list
pd = read.csv(file = paste0("../Generated_Data/Profile_Combination_Lists/",
                            model_name,"_Model/",profile_var,"_",
                            model_name,
                            "_profile_combination_list.csv"),
              header = TRUE)
#head(pd)
if(profile_var == "rho"){
  midway_max_jobs = 48
}else{
  midway_max_jobs = 50

}

mif_sim_combined_output_df = data.frame(
  matrix(nrow = 0, ncol = ncol(pd) + 1)
)
colnames(mif_sim_combined_output_df) = c(colnames(pd), "LL")

for(param_index in seq(1:midway_max_jobs)){
		#print(param_index)

  input_file_name = paste0("../Generated_Data/Profiles/", model_name,
                           "_Model/",profile_var,"_Profile/Subset_Outputs/",profile_var,
                           "_", model_name,
                           "_Profile_subset_",param_index,".csv")
  if(file.exists(input_file_name) == TRUE){
    mif_output_df_single_subset = read.csv(file = input_file_name)
  }else{
    group_size = nrow(pd)/midway_max_jobs
    start_index = (param_index-1)*group_size + 1
    end_index = param_index*group_size
    Num_mif_runs_per_start = 10
    param_data_subset_act = pd[start_index:end_index,]
    param_data_subset = param_data_subset_act[rep(seq_len(nrow(param_data_subset_act)), each = Num_mif_runs_per_start),]
    param_data_subset$seed = NA;
    param_data_subset$LL = NA;
    mif_output_df_single_subset = param_data_subset
  }

  #head(mif_output_df_single_subset)
  mif_sim_combined_output_df = rbind(mif_sim_combined_output_df, mif_output_df_single_subset)
}

output_file_name = paste0("../Generated_Data/Profiles/", model_name,"_Model/", profile_var, "_Profile/",
                          profile_var, "_", model_name, "_profile_combined_data.csv")
write.csv(mif_sim_combined_output_df, file = output_file_name, row.names=FALSE,na="")
}
combine_profile_output(profile_var = "sigma_P", model_name = model_name)
combine_profile_output(profile_var = "sigma_M", model_name = model_name)

combine_profile_output(profile_var = "I_0", model_name = model_name)
combine_profile_output(profile_var = "Beta_0", model_name = model_name)
combine_profile_output(profile_var = "delta", model_name = model_name)

combine_profile_output(profile_var = "rho", model_name = model_name)

combine_profile_output(profile_var = "phi", model_name = model_name)





```


# Plot profiles
For each profile, three plots are generated. The first plot("all_clean_data_points") shows the likelihoods of every MIF run conducted for that profile. The second plot is the actual plot of the profile. For the second plot, only the maximum likelihood of each profiled parameter value is shown on the plot. The third plot is a "zoom-in" of the region near the MLE, only showing combinations within 20 log-likelihood units of the MLE. On all three plots, red horizontal lines denote likelihood values 20 log-likelihood units below the profile MLE, while blue horizontal lines denote likelihood values 2 log-likelihood units below the MLE.

## Plotting function
```{r}
plot_profiles = function(profile_var, model_name){

#Load results
profile_data = read.csv(file = paste0("../Generated_Data/Profiles/", model_name, "_Model/", profile_var, "_Profile/",
                          profile_var, "_", model_name, "_profile_combined_data.csv"))
#head(profile_data)


profile_data_clean = na.omit(profile_data)


ML = max(profile_data_clean$LL)
cutoff_thres_20_LL_from_ML = ML - 20





cutoff_thres_2_LL_from_ML = ML - 2




### Take trace of profile (max at each value of profile variable)
profile_var_profile = aggregate(formula(paste0("LL ~ ",eval(profile_var))), profile_data_clean, max)




top_20_LL_units = filter(profile_var_profile, LL > cutoff_thres_20_LL_from_ML)

p = ggplot(data = top_20_LL_units, aes_string(x = eval(profile_var), y = "LL")) +
  geom_point() + geom_hline(yintercept = cutoff_thres_2_LL_from_ML,color = 'blue') +
  rahul_theme
print(p)

png(paste0("../Figures/Profiles/", model_name, "_Model/", profile_var, "_Profile/20_LL_from_ML_",
           profile_var, "_", model_name, "_profile.png"))
print(p)
dev.off()
}
```

## I_0 Profile

```{r}
plot_profiles(profile_var = "I_0", model_name = model_name)
```


## $\sigma_{\text{P}}$ Profile


```{r}
plot_profiles(profile_var = "sigma_P", model_name = model_name)
```


## $\sigma_{\text{M}}$ Profile


```{r}
plot_profiles(profile_var = "sigma_M", model_name = model_name)
```


## $\beta_0$ Profile


```{r}
plot_profiles(profile_var = "Beta_0", model_name = model_name)
```


## $delta$ Profile

```{r}
plot_profiles(profile_var = "delta", model_name = model_name)
```
## $\rho$ profile

```{r}
plot_profiles(profile_var = "rho", model_name = model_name)

```


## $phi$ Profile

```{r}
plot_profiles(profile_var = "phi", model_name = model_name)
```


# Combine profiles and plot end parameter estimates from MIF runs




## Combine profiles into one data frame

```{r}

# ---- combine_likelihoods_across_profiles ----
# Header ------------------------------------------------------------------
## Name: compare_likelihoods_across_profiles.R
## Author: Rahul Subramanian
## Description: Combine likelihoods across
## all expanded profiles



I_0_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                            "_Model/I_0_Profile/I_0_", model_name, "_profile_combined_data.csv"))
I_0_profile_data$Profile_Type = "I_0"
# E_0_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
#                             "_Model/E_0_Profile/E_0_", model_name, "_profile_combined_data.csv"))
# E_0_profile_data$Profile_Type = "E_0"

sigma_P_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                                "_Model/sigma_P_Profile/sigma_P_", model_name, "_profile_combined_data.csv"))
sigma_P_profile_data$Profile_Type = "sigma_P"
sigma_M_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                                "_Model/sigma_M_Profile/sigma_M_", model_name, "_profile_combined_data.csv"))
sigma_M_profile_data$Profile_Type = "sigma_M"

 combined_profile_data = rbind(sigma_P_profile_data, sigma_M_profile_data)
combined_profile_data = rbind(combined_profile_data, I_0_profile_data)
# combined_profile_data = rbind(combined_profile_data, E_0_profile_data)

 Beta_0_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                           "_Model/Beta_0_Profile/Beta_0_", model_name, "_profile_combined_data.csv"))
Beta_0_profile_data$Profile_Type = "Beta_0"


 combined_profile_data = rbind(combined_profile_data, Beta_0_profile_data)
# #head(combined_profile_data)
  delta_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                            "_Model/delta_Profile/delta_", model_name, "_profile_combined_data.csv"))
  delta_profile_data$Profile_Type = "delta"

combined_profile_data = rbind(combined_profile_data, delta_profile_data)
 rho_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                             "_Model/rho_Profile/rho_", model_name, "_profile_combined_data.csv"))
 rho_profile_data$Profile_Type = "rho"

 combined_profile_data = rbind(combined_profile_data, rho_profile_data)

phi_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
                            "_Model/phi_Profile/phi_", model_name, "_profile_combined_data.csv"))
phi_profile_data$Profile_Type = "phi"

combined_profile_data = rbind(combined_profile_data, phi_profile_data)




#epsilon_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
#                            "_Model/epsilon_Profile/epsilon_", model_name, "_profile_combined_data.csv"))
#epsilon_profile_data$Profile_Type = "epsilon"

#combined_profile_data = rbind(combined_profile_data, epsilon_profile_data)


#head(combined_profile_data)
# N_0_profile_data = read.csv(paste0("../Generated_Data/Profiles/", model_name,
#                             "_Model/N_0_Profile/N_0_", model_name, "_profile_combined_data.csv"))
# combined_profile_data = rbind(combined_profile_data, N_0_profile_data)

write.csv(combined_profile_data, file = paste0("../Generated_Data/Profiles/", model_name,
          "_Model/combined_", model_name, "_profile_data_directory.csv"),
          append = FALSE, row.names = FALSE)
```

# Plot Figure 3

### Source plot function

```{r}
source("Man_Figure_profile_facet_plots_plot_functions_simplified.R")
```

```{r, cache=FALSE}

knitr::read_chunk('Man_Figure_profile_facet_plots_plot_functions_simplified.R')
```

## Fig_3_Panel_A_B_C
```{r}
# Fig_3_Panel_A_B_C -------------------------------------------------------


rahul_poster_theme = theme(
  axis.title.x = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  axis.text.x = element_text(size = 21,
                             face = "bold",
                             color = "black"),
  axis.title.y = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  legend.title = element_text(size = 21,
                              face = "bold",
                              color = "black"),
  legend.text = element_text(size = 23,
                             face = "bold",
                             color = "black"),
  axis.text.y = element_text(size = 21,
                             face = "bold",
                             color = "black")
)
model_name_list = c("A_7")
model_label_list = factor(c("SIR Cosine No Immigration"))
model_label_list = factor(model_label_list, levels = c("SIR Cosine No Immigration"))

Csnippet_file_path_list = c("Csnippet_SIR_cosine_model.R")
Num_est_parameters_list = c(7)
data_file_path_list = c("../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv")

num_years_list = c(2.50)

model_ref_df = data.frame(model_name = model_name_list, model_label = model_label_list,
                          Csnippet_file_path = Csnippet_file_path_list,
                          Num_est_parameters = Num_est_parameters_list,
                          data_file_path = data_file_path_list,
                          num_years = num_years_list,stringsAsFactors = FALSE)
Sup_Fig_3A_df_colnames = c("Beta_0","LL", "Model",     
                           "Model_Name", "Profile_Var")
Sup_Fig_3A_prof_peak_treshold_df_colnames = c("Profile_threshold", "Model", "Model_Name")
Sup_Fig_3A_MLE_value_for_prof_var_df_colnames = c("MLE_value_for_prof_var", "Model", "Model_Name")
Sup_Fig_3A_prof_peak_value_for_prof_var_df_colnames = c("prof_peak_value_for_prof_var", "Model", "Model_Name")


Sup_Fig_3B_df_colnames = c("rho","LL" ,"Model",     
                           "Model_Name", "Profile_Var")
Sup_Fig_3B_prof_peak_treshold_df_colnames = c("Profile_threshold", "Model", "Model_Name")
Sup_Fig_3B_MLE_value_for_prof_var_df_colnames = c("MLE_value_for_prof_var", "Model", "Model_Name")
Sup_Fig_3B_prof_peak_value_for_prof_var_df_colnames = c("prof_peak_value_for_prof_var", "Model", "Model_Name")

Sup_Fig_3C_df_colnames = c("delta","LL" ,"Model",     
                           "Model_Name", "Profile_Var")
Sup_Fig_3C_prof_peak_treshold_df_colnames = c("Profile_threshold", "Model", "Model_Name")
Sup_Fig_3C_MLE_value_for_prof_var_df_colnames = c("MLE_value_for_prof_var", "Model", "Model_Name")
Sup_Fig_3C_prof_peak_value_for_prof_var_df_colnames = c("prof_peak_value_for_prof_var", "Model", "Model_Name")

ML_df_colnames = c("ML", "Model", "Model_Name")


Sup_Fig_3A_df = data.frame(matrix(nrow = 0,
                                  ncol = length(Sup_Fig_3A_df_colnames)))


Sup_Fig_3A_prof_peak_treshold_df = data.frame(matrix(nrow = 0,
                                                     ncol = length(Sup_Fig_3A_prof_peak_treshold_df_colnames)))
Sup_Fig_3A_MLE_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3A_MLE_value_for_prof_var_df_colnames)))
Sup_Fig_3A_prof_peak_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3A_prof_peak_value_for_prof_var_df_colnames)))

Sup_Fig_3B_df = data.frame(matrix(nrow = 0,
                                  ncol = length(Sup_Fig_3B_df_colnames)))
Sup_Fig_3B_prof_peak_treshold_df = data.frame(matrix(nrow = 0,
                                                     ncol = length(Sup_Fig_3B_prof_peak_treshold_df_colnames)))
Sup_Fig_3B_MLE_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3B_MLE_value_for_prof_var_df_colnames)))
Sup_Fig_3B_prof_peak_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3B_prof_peak_value_for_prof_var_df_colnames)))

Sup_Fig_3C_df = data.frame(matrix(nrow = 0,
                                  ncol = length(Sup_Fig_3C_df_colnames)))
Sup_Fig_3C_prof_peak_treshold_df = data.frame(matrix(nrow = 0,
                                                     ncol = length(Sup_Fig_3C_prof_peak_treshold_df_colnames)))
Sup_Fig_3C_MLE_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3C_MLE_value_for_prof_var_df_colnames)))
Sup_Fig_3C_prof_peak_value_for_prof_var_df =
  data.frame(matrix(nrow = 0, ncol = length(Sup_Fig_3C_prof_peak_value_for_prof_var_df_colnames)))

ML_df = data.frame(matrix(nrow = 0,
                          ncol = length(ML_df_colnames)))

colnames(Sup_Fig_3A_df) = Sup_Fig_3A_df_colnames
colnames(Sup_Fig_3A_prof_peak_treshold_df) = Sup_Fig_3A_prof_peak_treshold_df_colnames
colnames(Sup_Fig_3A_MLE_value_for_prof_var_df) = Sup_Fig_3A_MLE_value_for_prof_var_df_colnames
colnames(Sup_Fig_3A_prof_peak_value_for_prof_var_df) = Sup_Fig_3A_prof_peak_value_for_prof_var_df_colnames


colnames(Sup_Fig_3B_df) = Sup_Fig_3B_df_colnames
colnames(Sup_Fig_3B_prof_peak_treshold_df) = Sup_Fig_3B_prof_peak_treshold_df_colnames
colnames(Sup_Fig_3B_MLE_value_for_prof_var_df) = Sup_Fig_3B_MLE_value_for_prof_var_df_colnames
colnames(Sup_Fig_3B_prof_peak_value_for_prof_var_df) = Sup_Fig_3B_prof_peak_value_for_prof_var_df_colnames

colnames(Sup_Fig_3C_df) = Sup_Fig_3C_df_colnames
colnames(Sup_Fig_3C_prof_peak_treshold_df) = Sup_Fig_3C_prof_peak_treshold_df_colnames
colnames(Sup_Fig_3C_MLE_value_for_prof_var_df) = Sup_Fig_3C_MLE_value_for_prof_var_df_colnames
colnames(Sup_Fig_3C_prof_peak_value_for_prof_var_df) = Sup_Fig_3C_prof_peak_value_for_prof_var_df_colnames

colnames(ML_df) = ML_df_colnames

for(model_index in seq(1:length(model_name_list))){
  print(model_index)
  model_name = as.character(model_name_list[model_index])
  single_model_ref_data = filter(model_ref_df, model_name == !!model_name)
  model_label = single_model_ref_data$model_label
  Csnippet_file_path = single_model_ref_data$Csnippet_file_path
  Num_est_parameters = single_model_ref_data$Num_est_parameters
  data_file_path = single_model_ref_data$data_file_path
  num_years = single_model_ref_data$num_years
  
  Rio_data_clean = read.csv(file = data_file_path)
  
  Rio_clean_data = Rio_data_clean
  #head(Rio_data_clean)
  
  source(Csnippet_file_path, local = TRUE)
  
  #Set t0
  t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01"))
  
  #Load param combination directory
  combined_profile_data = read.csv(file = paste0("../Generated_Data/Profiles/", model_name,
                                                 "_Model/combined_", model_name,"_profile_data_directory.csv"))
  
  
  #head(combined_profile_data)
  ML = max(combined_profile_data$LL, na.rm = TRUE)
  MLE = filter(combined_profile_data, LL >= ML)
  
  ML_params = dplyr::select(MLE, -one_of("seed", "LL", "Profile_Type"))
  
  MLE
  single_model_ML_df = data.frame(ML = ML, Model = model_name, Model_Name = model_label)
  ML_df = rbind(ML_df, single_model_ML_df)
  #Get data for Sup Figure 3A
  profile_var = "Beta_0"
  single_model_output_list = get_profile_df(profile_var = profile_var, model_name = model_name,
                                            model_label = model_label, MLE = MLE)
  Sup_Fig_3A_df = rbind(Sup_Fig_3A_df, single_model_output_list[[1]])
  Sup_Fig_3A_prof_peak_treshold_df = rbind(Sup_Fig_3A_prof_peak_treshold_df, single_model_output_list[[2]])
  Sup_Fig_3A_MLE_value_for_prof_var_df = rbind(Sup_Fig_3A_MLE_value_for_prof_var_df,
                                               single_model_output_list[[3]])
  Sup_Fig_3A_prof_peak_value_for_prof_var_df = rbind(Sup_Fig_3A_prof_peak_value_for_prof_var_df,
                                                     single_model_output_list[[4]])
  
  #Get data for Sup Figure 3B
  profile_var = "rho"
  single_model_output_list = get_profile_df(profile_var = profile_var, model_name = model_name,
                                            model_label = model_label, MLE = MLE)
  Sup_Fig_3B_df = rbind(Sup_Fig_3B_df, single_model_output_list[[1]])
  Sup_Fig_3B_prof_peak_treshold_df = rbind(Sup_Fig_3B_prof_peak_treshold_df, single_model_output_list[[2]])
  Sup_Fig_3B_MLE_value_for_prof_var_df = rbind(Sup_Fig_3B_MLE_value_for_prof_var_df,
                                               single_model_output_list[[3]])
  Sup_Fig_3B_prof_peak_value_for_prof_var_df = rbind(Sup_Fig_3B_prof_peak_value_for_prof_var_df,
                                                     single_model_output_list[[4]])
  
  
  #Get data for Sup Figure 3C
  profile_var = "delta"
  single_model_output_list = get_profile_df(profile_var = profile_var, model_name = model_name,
                                            model_label = model_label, MLE = MLE)
  Sup_Fig_3C_df = rbind(Sup_Fig_3C_df, single_model_output_list[[1]])
  Sup_Fig_3C_prof_peak_treshold_df = rbind(Sup_Fig_3C_prof_peak_treshold_df, single_model_output_list[[2]])
  Sup_Fig_3C_MLE_value_for_prof_var_df = rbind(Sup_Fig_3C_MLE_value_for_prof_var_df,
                                               single_model_output_list[[3]])
  Sup_Fig_3C_prof_peak_value_for_prof_var_df = rbind(Sup_Fig_3C_prof_peak_value_for_prof_var_df,
                                                     single_model_output_list[[4]])
  
}

##Plotting function

Sup_Fig_3_A = plot_profiles_simple(profile_var = "Beta_0", Sup_Fig_df = Sup_Fig_3A_df,
                            Sup_Fig_prof_peak_treshold_df = Sup_Fig_3A_prof_peak_treshold_df,
                            Sup_Fig_MLE_value_for_prof_var_df = Sup_Fig_3A_MLE_value_for_prof_var_df,
                            Sup_Fig_prof_peak_value_for_prof_var_df =
                              Sup_Fig_3A_prof_peak_value_for_prof_var_df,
                            Fig_lab = "3A", ML_df = ML_df,
                            plot_var_label = "beta[0]")
Sup_Fig_3_B = plot_profiles_simple(profile_var = "rho", Sup_Fig_df = Sup_Fig_3B_df,
                            Sup_Fig_prof_peak_treshold_df = Sup_Fig_3B_prof_peak_treshold_df,
                            Sup_Fig_MLE_value_for_prof_var_df = Sup_Fig_3B_MLE_value_for_prof_var_df,
                            Sup_Fig_prof_peak_value_for_prof_var_df =
                              Sup_Fig_3B_prof_peak_value_for_prof_var_df,
                            Fig_lab = "3B", ML_df = ML_df,
                            plot_var_label = "rho")
Sup_Fig_3_C = plot_profiles_simple(profile_var = "delta", Sup_Fig_df = Sup_Fig_3C_df,
                            Sup_Fig_prof_peak_treshold_df = Sup_Fig_3C_prof_peak_treshold_df,
                            Sup_Fig_MLE_value_for_prof_var_df = Sup_Fig_3C_MLE_value_for_prof_var_df,
                            Sup_Fig_prof_peak_value_for_prof_var_df =
                              Sup_Fig_3C_prof_peak_value_for_prof_var_df,
                            Fig_lab = "3C", ML_df = ML_df,
                            plot_var_label = "delta")


```

## Make combined plot of panels A,B, and C
```{r}
# Combined Plot -----------------------------------------------------------

library(gridExtra)
library(grid)
library(lattice)

rahul_panel_theme = theme(
  axis.title.x = element_text(size = 10,
                              face = "bold",
                              color = "black"),
  axis.text.x = element_text(size = 10,
                             face = "bold",
                             color = "black"),
  axis.title.y = element_text(size = 10,
                              face = "bold",
                              color = "black"),
  legend.title = element_text(size = 10,
                              face = "bold",
                              color = "black"),
  legend.text = element_text(size = 9,
                             face = "bold",
                             color = "black"),
  axis.text.y = element_text(size = 8,
                             face = "bold",
                             color = "black")
)

rahul_big_panel_theme = theme(
  axis.title.x = element_text(size = 14,
                              face = "bold",
                              color = "black"),
  axis.text.x = element_text(size = 12,
                             face = "bold",
                             color = "black"),
  axis.title.y = element_text(size = 14,
                              face = "bold",
                              color = "black"),
  legend.title = element_text(size = 14,
                              face = "bold",
                              color = "black"),
  legend.text = element_text(size = 12,
                             face = "bold",
                             color = "black"),
  axis.text.y = element_text(size = 12,
                             face = "bold",
                             color = "black"),
  plot.margin = unit(c(.5,.5,.5,.5), "cm"),
  legend.background = element_rect(fill = "transparent"),
  legend.box.margin = unit(c(.5,.5,.5,.5), "cm")
)

Sup_Fig_3_A_comb = Sup_Fig_3_A + rahul_big_panel_theme + theme(legend.position = "None")
Sup_Fig_3_B_comb = Sup_Fig_3_B + rahul_big_panel_theme + theme(legend.position = "None")
Sup_Fig_3_C_comb = Sup_Fig_3_C + rahul_big_panel_theme + theme(legend.position = "None")

Sup_Fig_3_A_small_legend = Sup_Fig_3_A +
  rahul_big_panel_theme +
  theme(legend.key=element_blank()) 
legend <- cowplot::get_legend(Sup_Fig_3_A_small_legend)





Fig_3_Panel_A = Sup_Fig_3_A_comb
Fig_3_Panel_B = Sup_Fig_3_B_comb
Fig_3_Panel_C = Sup_Fig_3_C_comb
Fig_3_ABC_Legend = legend

```

## Fig_3_Panel_D

```{r}
# Fig_3_Panel_D ------------------------------------------------------------


model_name  = "A_7"

bio_good_2_LL = read.csv(paste0("../Generated_Data/Profiles/", model_name, "_Model/",model_name, "_Model_BP_top_2_LL_all_params_bio_good_2_LL.csv"))
ML_combo_num = which(bio_good_2_LL$LL == max(bio_good_2_LL$LL))
all_R0_data = 
  read.csv(paste0("../Generated_Data/Profiles/",
                  model_name, "_Model/",
                  model_name, "_Model_BP_top_2_LL_all_params_sim_R0_data.csv"))

R0_min = aggregate(R_0 ~ time, all_R0_data, FUN = min)
R0_min = dplyr::select(R0_min, time = time, R_0_min = R_0)
R0_max = aggregate(R_0 ~ time, all_R0_data, FUN = max)
R0_max = dplyr::select(R0_max, time = time, R_0_max = R_0)
ML_R0_df = filter(all_R0_data, combo_num == ML_combo_num)
ML_R0_df = dplyr::select(ML_R0_df, time = time, R_0_MLE = R_0)
R_0_ribbon_df = join(R0_min, R0_max)

R_0_ribbon_df = join(R_0_ribbon_df, ML_R0_df)

R_0_ribbon_df_melt = melt(R_0_ribbon_df, id.vars = c("time", "R_0_min", "R_0_max" ))
ribbon_label = "R_0 range \n  (All  2 LL Combinations)"
R_0_ribbon_df_melt$Ribbon_label = ribbon_label
## R_0 upper and lower bounds for on and off-season peak and trough
min(R_0_ribbon_df_melt$R_0_min)
min(R_0_ribbon_df_melt$R_0_max)
max(R_0_ribbon_df_melt$R_0_min)
max(R_0_ribbon_df_melt$R_0_max)

fill_vec = c("grey70", "NA")
names(fill_vec) = ribbon_label


### Plot 1 year only

all_R0_data$Year = all_R0_data$time/365
all_R0_data$Days_in_Year = (all_R0_data$time%%365)
all_R0_data$Month = round((all_R0_data$Days_in_Year/365)*12) + 1
single_year_R_0_data= filter(all_R0_data, Year <=  2 & Year >= 1 )
single_year_R_0_data$Month_Name = c(month.abb, month.abb[1])

single_year_R0_min = aggregate(R_0 ~ time, single_year_R_0_data,
                               FUN = min)
single_year_R0_min = dplyr::select(single_year_R0_min, time = time, R_0_min = R_0)
single_year_R0_max = aggregate(R_0 ~ time, single_year_R_0_data,
                               FUN = max)
single_year_R0_max = dplyr::select(single_year_R0_max, time = time,
                                   R_0_max = R_0)
single_year_ML_R0_df = filter(single_year_R_0_data,
                              combo_num == ML_combo_num)
single_year_ML_R0_df = dplyr::select(single_year_ML_R0_df,
                                     time = time, R_0_MLE = R_0)
single_year_R_0_ribbon_df = join(single_year_R0_min,
                                 single_year_R0_max)

single_year_R_0_ribbon_df = join(single_year_R_0_ribbon_df,
                                 single_year_ML_R0_df)

single_year_R_0_ribbon_df_melt = 
  melt(single_year_R_0_ribbon_df,
       id.vars = c("time", "R_0_min", "R_0_max" ))
ribbon_label = "R_0 range \n  (All  2 LL Combinations)"
single_year_R_0_ribbon_df_melt$Ribbon_label = ribbon_label
fill_vec = c("grey70")
names(fill_vec) = ribbon_label
plot_label_months =seq(from = 1, to = 13, by = 2)
plot_label_month_names =
  single_year_R_0_data$Month_Name[plot_label_months]

plot_label_times = single_year_R_0_data$time[plot_label_months]



ribbon_label = "2 LL from \n MLE"
single_year_R_0_ribbon_df_melt$Ribbon_label = ribbon_label
fill_vec = c("grey70")
names(fill_vec) = ribbon_label

Fig_3_Panel_D = ggplot(data = single_year_R_0_ribbon_df_melt) +
  geom_ribbon(aes(x = time, ymin = R_0_min, ymax =  R_0_max, fill = Ribbon_label)) +
  geom_line(aes(x = time, y = value, color = variable)) +
  geom_point(aes(x = time, y = value, color = variable),
             size = 3) +
  rahul_theme +
  theme(legend.text = element_text(size = 12,
                                   face = "bold",
                                   color = "black")) +
  theme_white_background +
  scale_color_manual(name = "", values = c("red"),
                     labels = c(
                       "MLE Trajectory \n (Shaded Region: \n 95% Quantiles)",
                                         "Observed"))  +
  scale_fill_manual(name = "", values = fill_vec,
                    labels = c(
                      "MLE Trajectory \n (Shaded Region: \n 95% Quantiles)",
                      "Observed")) +
  xlab("Month")+
  scale_x_continuous(
    breaks = as.numeric(plot_label_times),
    labels = plot_label_month_names) +
  ylab(expression(paste(R[0]))) +
  rahul_man_figure_theme +
  theme(legend.margin = margin(t = 0, unit='cm'))
Fig_3_Panel_D
tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig6.tiff"),
  height = 5, width = 10, res = 300, units = "in")
print(Fig_3_Panel_D)
dev.off()



```

## Figure 3 Panel E
```{r}
# Figure 3 Panel E --------------------------------------------------------


rahul_poster_theme = theme(
  axis.title.x = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  axis.text.x = element_text(size = 21,
                             face = "bold",
                             color = "black"),
  axis.title.y = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  legend.title = element_text(size = 21,
                              face = "bold",
                              color = "black"),
  legend.text = element_text(size = 23,
                             face = "bold",
                             color = "black"),
  axis.text.y = element_text(size = 21,
                             face = "bold",
                             color = "black")
)

model_name_list = c("A_7")
model_label_list = factor(c("SIR Cosine No Immigration"))
model_label_list = factor(model_label_list, levels = c("SIR Cosine No Immigration"))

Csnippet_file_path_list = c("Csnippet_SIR_cosine_model.R")
Num_est_parameters_list = c(7)
data_file_path_list = c("../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv")

num_years_list = c(2.50)

model_ref_df = data.frame(
  model_name = model_name_list,
  model_label = model_label_list,
  Csnippet_file_path = Csnippet_file_path_list,
  Num_est_parameters = Num_est_parameters_list,
  data_file_path = data_file_path_list,
  num_years = num_years_list,
  stringsAsFactors = FALSE
)


model_index = 1
print(model_index)
model_name = as.character(model_name_list[model_index])
single_model_ref_data = filter(model_ref_df, model_name == !!model_name)
model_label = single_model_ref_data$model_label
Csnippet_file_path = single_model_ref_data$Csnippet_file_path
Num_est_parameters = single_model_ref_data$Num_est_parameters
data_file_path = single_model_ref_data$data_file_path
num_years = single_model_ref_data$num_years

Rio_data_clean = read.csv(file = data_file_path)

Rio_clean_data = Rio_data_clean
#head(Rio_data_clean)

source(Csnippet_file_path, local = TRUE)

#Set t0
t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01"))

all_combo_data = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/",
    model_name,
    "_Model_BP_top_2_LL_all_params_sim_cases_data.csv"
  )
)

all_R0_data = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/",
    model_name,
    "_Model_BP_top_2_LL_all_params_sim_R0_data.csv"
  )
)

all_combo_S_data = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/",
    model_name,
    "_Model_BP_top_2_LL_all_params_sim_S_over_N_data.csv"
  )
)

all_R_eff_data = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/",
    model_name,
    "_Model_BP_top_2_LL_all_params_sim_Reff_data.csv"
  )
)

bio_good_2_LL = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/",
    model_name,
    "_Model_BP_top_2_LL_all_params_bio_good_2_LL.csv"
  )
)

# Get data for Sup Figure 2A and 2B

ML_combo_num = which(bio_good_2_LL$LL == max(bio_good_2_LL$LL))

ML_output = filter(all_combo_data, combo_num == ML_combo_num)
ML_output = dplyr::select(
  ML_output,
  time = time,
  ML_median = sim_data_median,
  ML_high_Q = sim_data_high_Q,
  ML_low_Q = sim_data_low_Q
)
true_data = dplyr::select(Rio_clean_data, time = times,
                          Observed_Data = Y)
comp_data = join(ML_output, true_data)




comp_data_melt = melt(comp_data, id.vars = c("time",
                                             "ML_high_Q", "ML_low_Q"))


label_df  =
  data.frame(Label_name =
               c("Simulation Median \n (Shaded Region: \n 95% Quantiles)",
                 "Observed"),
             variable = c("ML_median",
                          "Observed_Data"))

comp_data_melt_with_label = 
  join(comp_data_melt, label_df)



Fig_3_Panel_E =
  ggplot(data = comp_data_melt_with_label) +
  geom_ribbon(aes(
    x = time / 365,
    ymin = log(ML_low_Q),
    ymax = log(ML_high_Q),
    fill = Label_name
  )) +
  geom_line(aes(
    x = time / 365,
    y = log(value),
    color = Label_name
  )) +
  geom_point(aes(
    x = time / 365,
    y = log(value),
    color = Label_name),
    size = 3) +
  rahul_theme +
  theme_white_background +
   rahul_man_figure_theme +
  xlab("Years since Jan 1 1986") +
  ylab("log(Monthly \n Reported Cases)") 

Fig_3_Panel_E = Fig_3_Panel_E +
  scale_color_manual(name = "",
                     values = c("red",
                                "blue"),
                     labels = c(
                       "Simulation Median \n (Shaded Region: \n 95% Quantiles)",
                     "Observed")) +
  scale_fill_manual(name = "",
                     values = c("grey70",
                                "NA"),
                     labels = c("Simulation Median \n (Shaded Region: \n 95% Quantiles)",
                                "Observed"))


```

## Combined plot of all panels for Figure 3
```{r}
# Make_Combined_Plot ------------------------------------------------------
low_thres = ML_df$ML - 10

up_thres = ML_df$ML + 2

Fig_3_Panel_A = Fig_3_Panel_A +
  scale_y_continuous(breaks = scales::pretty_breaks(3)) +
  ylim(low_thres,up_thres) +
  xlim(0.05, 0.10)+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
Fig_3_Panel_B = Fig_3_Panel_B +
  scale_y_continuous(breaks = scales::pretty_breaks(3))+
  ylim(low_thres,up_thres) +
  xlim(0.01, 0.15)+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

Fig_3_Panel_C = Fig_3_Panel_C +
  scale_y_continuous(breaks = scales::pretty_breaks(3)) +
  ylim(low_thres,up_thres) +
  xlim(0.35, 0.90)+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

Fig_3_Panel_E = Fig_3_Panel_E + theme(legend.position = c(.78,.83)) +
  rahul_big_panel_theme +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
Fig_3_Panel_D = Fig_3_Panel_D + theme(legend.position = c(.20,.30)) +
  rahul_big_panel_theme +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))






lay <- rbind(c(1,1,4,4,4,4),
               c(1,1,4,4,4,4),
               c(1,1,4,4,4,4),
               c(1,1,4,4,4,4),
               c(2,2,4,4,4,4),
               c(2,2,4,4,4,4),
               c(2,2,4,4,4,4),
               c(2,2,4,4,4,4),
               c(3,3,5,5,5,5),
               c(3,3,5,5,5,5),
               c(3,3,5,5,5,5),
               c(3,3,5,5,5,5),
               c(6,6,5,5,5,5),
               c(6,6,5,5,5,5))



tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig3_raw.tiff"),
  height = 5, width = 10, res = 500, units = "in")# print(grid.arrange(Sup_Fig_3_A_comb, Sup_Fig_3_B_comb, legend,Sup_Fig_3_C_comb, Sup_Fig_3_D_comb,
#                    ncol = 3, widths = c(1,1,0.9)))
grid.arrange(grobs = list(Fig_3_Panel_A, Fig_3_Panel_B,
                          Fig_3_Panel_C,
                          Fig_3_Panel_D,
                          Fig_3_Panel_E,
                          legend), layout_matrix = lay)
dev.off()

```

#  Figure 1 Revised

```{r}
rm(list =ls())
source("load_libraries_essential.R")
source("rahul_theme.R")
library(stringr)
library(gridExtra)
library(zoo)
load("../Generated_Data/Skip_Data/nCritics.Rdata")
head(nCritics)
row.names(nCritics)
colnames(nCritics)
skip_raw_data = as.numeric(as.character(nCritics))
skip_data = as.data.frame(as.matrix(nCritics))

dim(nCritics) #18 (Reporitng rate) x 11 (delta) x 491 (R_0 value)
# Row name: Reporting rate (18 from 1% to 50%)


#reporting_rates = strsplit(reporting_rate, "%")
rep_rate_header = str_split(row.names(nCritics), pattern = "%", n = Inf,
              simplify = TRUE)
delta_col_header = str_split(colnames(nCritics), pattern = "_", n = Inf,
                             simplify = TRUE)
reporting_rate = as.numeric(rep_rate_header[,2])/100
delta_val = as.numeric(delta_col_header[,2])

# Reporitng Rates corresponding to S_0 values of 70%, 85%, and 90%
nine_percent_rho_index = which(reporting_rate == .09) 
six_percent_rho_index = which(reporting_rate == .06) 
three_percent_rho_index = which(reporting_rate == .03) 



R_0_col_header = str_split(names(nCritics[1,1,]), pattern = "_", n = Inf,
                             simplify = TRUE)
R_0_skip_val = as.numeric(R_0_col_header[,2])

#Get 9% rho skip data
skip_data_rho_nine_percent = 
  nCritics[nine_percent_rho_index,
           c(3,5,7,8,9),
           c(91:181)]
skip_df_rho_9 = as.data.frame(skip_data_rho_nine_percent)
skip_df_rho_9 <- tibble::rownames_to_column(skip_df_rho_9, "delta")
strsplit(skip_df_rho_9$delta, split = "_")
colnames(skip_df_rho_9)
rownames(skip_df_rho_9)
library(stringr)
skip_df_rho_9$delta = str_split(skip_df_rho_9$delta,
                                pattern = "_", simplify = TRUE)[,2]
head(skip_df_rho_9)

skip_df_rho_9 = melt(skip_df_rho_9, id.vars = c("delta"))
skip_df_rho_9 = dplyr::select(skip_df_rho_9, delta, r0 = variable,
                              Num_Skips = value)
skip_df_rho_9$r0 = str_split(skip_df_rho_9$r0,
                             pattern = "_", simplify = TRUE)[,2]
skip_df_rho_9$rho = 0.09
skip_df_rho_9$rho_lab = "\rho~=~0.09" 


#Get 6% rho skip data
skip_data_rho_six_percent = 
  nCritics[six_percent_rho_index,
           c(3,5,7,8,9),
           c(91:181)]
skip_df_rho_6 = as.data.frame(skip_data_rho_six_percent)
skip_df_rho_6 <- tibble::rownames_to_column(skip_df_rho_6, "delta")
strsplit(skip_df_rho_6$delta, split = "_")
colnames(skip_df_rho_6)
rownames(skip_df_rho_6)
library(stringr)
skip_df_rho_6$delta = str_split(skip_df_rho_6$delta,
                          pattern = "_", simplify = TRUE)[,2]
head(skip_df_rho_6)

skip_df_rho_6 = melt(skip_df_rho_6, id.vars = c("delta"))
skip_df_rho_6 = dplyr::select(skip_df_rho_6, delta, r0 = variable,
                        Num_Skips = value)
skip_df_rho_6$r0 = str_split(skip_df_rho_6$r0,
                          pattern = "_", simplify = TRUE)[,2]
skip_df_rho_6$rho = 0.06
skip_df_rho_6$rho_lab = "\rho~=~0.06" 


#Get 3% rho skip data
skip_data_rho_three_percent = 
  nCritics[three_percent_rho_index,
           c(3,5,7,8,9),
           c(91:181)]
skip_df_rho_3 = as.data.frame(skip_data_rho_three_percent)
skip_df_rho_3 <- tibble::rownames_to_column(skip_df_rho_3, "delta")
strsplit(skip_df_rho_3$delta, split = "_")
colnames(skip_df_rho_3)
rownames(skip_df_rho_3)
library(stringr)
skip_df_rho_3$delta = str_split(skip_df_rho_3$delta,
                                 pattern = "_", simplify = TRUE)[,2]
head(skip_df_rho_3)

skip_df_rho_3 = melt(skip_df_rho_3, id.vars = c("delta"))
skip_df_rho_3 = dplyr::select(skip_df_rho_3, delta, r0 = variable,
                               Num_Skips = value)
skip_df_rho_3$r0 = str_split(skip_df_rho_3$r0,
                              pattern = "_", simplify = TRUE)[,2]
skip_df_rho_3$rho = 0.03
skip_df_rho_3$rho_lab = "\rho~=~0.03" 

skip_df = rbind(skip_df_rho_3,
                skip_df_rho_6)
skip_df = rbind(skip_df,
                skip_df_rho_9)
skip_df$r0 = as.numeric(as.character(skip_df$r0))
skip_df$Num_Skips = as.numeric(as.character(skip_df$Num_Skips))


library(latex2exp)




only_delta_07 = filter(skip_df, delta == 0.7)
head(only_delta_07)
only_delta_07$rho = as.factor(as.character(only_delta_07$rho))
p = ggplot(data = only_delta_07, aes(x = r0, y = Num_Skips,
                               color = rho)) + geom_point(size = 3) +
  rahul_theme +
  theme_white_background + scale_color_viridis_d(direction = -1)+
  ylab("Number of skips")  + labs(x = expression(R[0])) +
  labs(color = expression(rho))+
  rahul_man_figure_theme 
p

# TIFF Figure 1 -----------------------------------------------------------
source("TIFF_Man_Fig_1.R")

```

# Plot Figure 2 Revised 
```{r}
rm(list =ls())
source("load_libraries_essential.R")
source("rahul_theme.R")
library(stringr)
library(gridExtra)
library(zoo)
load("../Generated_Data/Skip_Data/nCritics.Rdata")
head(nCritics)
row.names(nCritics)
colnames(nCritics)
skip_raw_data = as.numeric(as.character(nCritics))
skip_data = as.data.frame(as.matrix(nCritics))

dim(nCritics) #18 (Reporitng rate) x 11 (delta) x 491 (R_0 value)
# Row name: Reporting rate (18 from 1% to 50%)


#reporting_rates = strsplit(reporting_rate, "%")
rep_rate_header = str_split(row.names(nCritics), pattern = "%", n = Inf,
              simplify = TRUE)
delta_col_header = str_split(colnames(nCritics), pattern = "_", n = Inf,
                             simplify = TRUE)
reporting_rate = as.numeric(rep_rate_header[,2])/100
delta_val = as.numeric(delta_col_header[,2])

#10% Reporitng Rates
ten_percent_rho_index = which(reporting_rate == .10) 
three_percent_rho_index = which(reporting_rate == .03) 



R_0_col_header = str_split(names(nCritics[1,1,]), pattern = "_", n = Inf,
                             simplify = TRUE)
R_0_skip_val = as.numeric(R_0_col_header[,2])

#Get 10% rho skip data
skip_data_rho_ten_percent = 
  nCritics[ten_percent_rho_index,
           c(3,5,7,8,9),
           c(91:181)]
skip_df_rho_10 = as.data.frame(skip_data_rho_ten_percent)
skip_df_rho_10 <- tibble::rownames_to_column(skip_df_rho_10, "delta")
strsplit(skip_df_rho_10$delta, split = "_")
colnames(skip_df_rho_10)
rownames(skip_df_rho_10)
library(stringr)
skip_df_rho_10$delta = str_split(skip_df_rho_10$delta,
                                pattern = "_", simplify = TRUE)[,2]
head(skip_df_rho_10)

skip_df_rho_10 = melt(skip_df_rho_10, id.vars = c("delta"))
skip_df_rho_10 = dplyr::select(skip_df_rho_10, delta, r0 = variable,
                              Num_Skips = value)
skip_df_rho_10$r0 = str_split(skip_df_rho_10$r0,
                             pattern = "_", simplify = TRUE)[,2]
skip_df_rho_10$rho = 0.10
skip_df_rho_10$rho_lab = "\rho~=~0.10" 




#Get 3% rho skip data
skip_data_rho_three_percent = 
  nCritics[three_percent_rho_index,
           c(3,5,7,8,9),
           c(91:181)]
skip_df_rho_3 = as.data.frame(skip_data_rho_three_percent)
skip_df_rho_3 <- tibble::rownames_to_column(skip_df_rho_3, "delta")
strsplit(skip_df_rho_3$delta, split = "_")
colnames(skip_df_rho_3)
rownames(skip_df_rho_3)
library(stringr)
skip_df_rho_3$delta = str_split(skip_df_rho_3$delta,
                                 pattern = "_", simplify = TRUE)[,2]
head(skip_df_rho_3)

skip_df_rho_3 = melt(skip_df_rho_3, id.vars = c("delta"))
skip_df_rho_3 = dplyr::select(skip_df_rho_3, delta, r0 = variable,
                               Num_Skips = value)
skip_df_rho_3$r0 = str_split(skip_df_rho_3$r0,
                              pattern = "_", simplify = TRUE)[,2]
skip_df_rho_3$rho = 0.03
skip_df_rho_3$rho_lab = "\rho~=~0.03" 


skip_df = rbind(skip_df_rho_3,
                skip_df_rho_10)
skip_df$r0 = as.numeric(as.character(skip_df$r0))
skip_df$Num_Skips = as.numeric(as.character(skip_df$Num_Skips))


library(latex2exp)




only_delta_07 = filter(skip_df, delta == 0.7)
head(only_delta_07)
only_delta_07$rho = as.factor(as.character(only_delta_07$rho))
# p = ggplot(data = only_delta_07, aes(x = r0, y = Num_Skips,
#                                shape = rho)) + geom_point(size = 3) +
#   rahul_theme +
#   scale_shape_manual(values = c(15,17))+
#   theme_white_background + scale_color_viridis_d(direction = -1)+
#   ylab("Number of skips")  + labs(x = expression(R[0])) +
#   labs(shape = expression(rho))+
#   rahul_man_figure_theme 
# p


Fig_2_B = ggplot(data = only_delta_07) + geom_point(data = only_delta_07,
                          aes(x = r0, y = Num_Skips,
                              shape = rho),size = 3 )+
  labs(shape = expression(rho)) +
  rahul_theme +
  theme_white_background + scale_shape_manual(values = c(18,17))+
  labs(x = expression(R[0])) +
  labs(y = expression(n[c])) +
  labs(y = expression(paste("Number of skips (", n[c], ")")))
  labs(shape = expression(rho))+
  rahul_man_figure_theme
Fig_2_B

tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig2B.tiff"),
  height = 5, width = 10, res = 300, units = "in")
print(Fig_2_B)
dev.off()

#only_delta_07$Type = "Simulated"
##### Load data from old figure 8 


#Load bio_good LL

model_name = "A_7"


## R_naught_act_data
profile_data_with_R_naught_act = read.csv(file = paste0("../Generated_Data/Profiles/", model_name,
                                                        "_Model/combined_", model_name, "_profile_data_directory_with_mean_R_0.csv"))

head(profile_data_with_R_naught_act)
MLE_with_R_naught_act = filter(profile_data_with_R_naught_act, LL == max(LL))
bio_good_2_LL_with_R_naught = read.csv(file = paste0("../Generated_Data/Profiles/", model_name,
                                                     "_Model/combined_", model_name, "_bio_good_2_LL_param_list.csv"))
A_7_MLE_R_naught_act = MLE_with_R_naught_act$R_naught
A_7_min_R_naught_act = min(bio_good_2_LL_with_R_naught$R_naught)
A_7_max_R_naught_act = max(bio_good_2_LL_with_R_naught$R_naught)

A_7_bio_good_2_LL = read.csv(paste0("../Generated_Data/Profiles/", model_name, "_Model/",model_name, "_Model_BP_top_2_LL_all_params_bio_good_2_LL.csv"))

A_7_bio_good_2_LL$R_naught_theo = A_7_bio_good_2_LL$Beta_0/(A_7_bio_good_2_LL$gamma + A_7_bio_good_2_LL$mu_H)

head(A_7_bio_good_2_LL)
A_7_bio_good_2_LL$nearest_skip_rho = 0
A_7_bio_good_2_LL$nearest_skip_R_naught = 0
A_7_bio_good_2_LL$nearest_skip_delta = 0
A_7_bio_good_2_LL$skips = -1
#single_param_data$nearest_skip_R_naught_index = NA
A_7_bio_good_2_LL$nearest_skip_delta_index = NA
A_7_bio_good_2_LL$nearest_skip_rho_index = NA


```

# Plot Figure 2
<!-- ### Old Figure 2B -->
<!-- ```{r} -->
<!-- rm(list =ls()) -->
<!-- source("load_libraries_essential.R") -->
<!-- source("rahul_theme.R") -->
<!-- library(stringr) -->
<!-- library(gridExtra) -->
<!-- library(zoo) -->
<!-- load("../Generated_Data/Skip_Data/nCritics.Rdata") -->
<!-- head(nCritics) -->
<!-- row.names(nCritics) -->
<!-- colnames(nCritics) -->
<!-- skip_raw_data = as.numeric(as.character(nCritics)) -->
<!-- skip_data = as.data.frame(as.matrix(nCritics)) -->

<!-- dim(nCritics) #18 (Reporitng rate) x 11 (delta) x 491 (R_0 value) -->
<!-- # Row name: Reporting rate (18 from 1% to 50%) -->


<!-- #reporting_rates = strsplit(reporting_rate, "%") -->
<!-- rep_rate_header = str_split(row.names(nCritics), pattern = "%", n = Inf, -->
<!--               simplify = TRUE) -->
<!-- delta_col_header = str_split(colnames(nCritics), pattern = "_", n = Inf, -->
<!--                              simplify = TRUE) -->
<!-- reporting_rate = as.numeric(rep_rate_header[,2])/100 -->
<!-- delta_val = as.numeric(delta_col_header[,2]) -->

<!-- #10% Reporitng Rates -->
<!-- ten_percent_rho_index = which(reporting_rate == .10) -->
<!-- three_percent_rho_index = which(reporting_rate == .03) -->



<!-- R_0_col_header = str_split(names(nCritics[1,1,]), pattern = "_", n = Inf, -->
<!--                              simplify = TRUE) -->
<!-- R_0_skip_val = as.numeric(R_0_col_header[,2]) -->

<!-- #Get 10% rho skip data -->
<!-- skip_data_rho_ten_percent = -->
<!--   nCritics[ten_percent_rho_index, -->
<!--            c(3,5,7,8,9), -->
<!--            c(91:181)] -->
<!-- skip_df_rho_10 = as.data.frame(skip_data_rho_ten_percent) -->
<!-- skip_df_rho_10 <- tibble::rownames_to_column(skip_df_rho_10, "delta") -->
<!-- strsplit(skip_df_rho_10$delta, split = "_") -->
<!-- colnames(skip_df_rho_10) -->
<!-- rownames(skip_df_rho_10) -->
<!-- library(stringr) -->
<!-- skip_df_rho_10$delta = str_split(skip_df_rho_10$delta, -->
<!--                                 pattern = "_", simplify = TRUE)[,2] -->
<!-- head(skip_df_rho_10) -->

<!-- skip_df_rho_10 = melt(skip_df_rho_10, id.vars = c("delta")) -->
<!-- skip_df_rho_10 = dplyr::select(skip_df_rho_10, delta, r0 = variable, -->
<!--                               Num_Skips = value) -->
<!-- skip_df_rho_10$r0 = str_split(skip_df_rho_10$r0, -->
<!--                              pattern = "_", simplify = TRUE)[,2] -->
<!-- skip_df_rho_10$rho = 0.10 -->
<!-- skip_df_rho_10$rho_lab = "\rho~=~0.10" -->




<!-- #Get 3% rho skip data -->
<!-- skip_data_rho_three_percent = -->
<!--   nCritics[three_percent_rho_index, -->
<!--            c(3,5,7,8,9), -->
<!--            c(91:181)] -->
<!-- skip_df_rho_3 = as.data.frame(skip_data_rho_three_percent) -->
<!-- skip_df_rho_3 <- tibble::rownames_to_column(skip_df_rho_3, "delta") -->
<!-- strsplit(skip_df_rho_3$delta, split = "_") -->
<!-- colnames(skip_df_rho_3) -->
<!-- rownames(skip_df_rho_3) -->
<!-- library(stringr) -->
<!-- skip_df_rho_3$delta = str_split(skip_df_rho_3$delta, -->
<!--                                  pattern = "_", simplify = TRUE)[,2] -->
<!-- head(skip_df_rho_3) -->

<!-- skip_df_rho_3 = melt(skip_df_rho_3, id.vars = c("delta")) -->
<!-- skip_df_rho_3 = dplyr::select(skip_df_rho_3, delta, r0 = variable, -->
<!--                                Num_Skips = value) -->
<!-- skip_df_rho_3$r0 = str_split(skip_df_rho_3$r0, -->
<!--                               pattern = "_", simplify = TRUE)[,2] -->
<!-- skip_df_rho_3$rho = 0.03 -->
<!-- skip_df_rho_3$rho_lab = "\rho~=~0.03" -->


<!-- skip_df = rbind(skip_df_rho_3, -->
<!--                 skip_df_rho_10) -->
<!-- skip_df$r0 = as.numeric(as.character(skip_df$r0)) -->
<!-- skip_df$Num_Skips = as.numeric(as.character(skip_df$Num_Skips)) -->


<!-- library(latex2exp) -->




<!-- only_delta_07 = filter(skip_df, delta == 0.7) -->
<!-- head(only_delta_07) -->
<!-- only_delta_07$rho = as.factor(as.character(only_delta_07$rho)) -->
<!-- p = ggplot(data = only_delta_07, aes(x = r0, y = Num_Skips, -->
<!--                                color = rho)) + geom_point(size = 3) + -->
<!--   rahul_theme + -->
<!--   theme_white_background + scale_color_viridis_d(direction = -1)+ -->
<!--   ylab("Number of skips")  + labs(x = expression(R[0])) + -->
<!--   labs(color = expression(rho))+ -->
<!--   rahul_man_figure_theme -->
<!-- p -->




<!-- #only_delta_07$Type = "Simulated" -->
<!-- ##### Load data from old figure 8 -->


<!-- #Load bio_good LL -->

<!-- model_name = "A_7" -->


<!-- ## R_naught_act_data -->
<!-- profile_data_with_R_naught_act = read.csv(file = paste0("../Generated_Data/Profiles/", model_name, -->
<!--                                                         "_Model/combined_", model_name, "_profile_data_directory_with_mean_R_0.csv")) -->

<!-- head(profile_data_with_R_naught_act) -->
<!-- MLE_with_R_naught_act = filter(profile_data_with_R_naught_act, LL == max(LL)) -->
<!-- bio_good_2_LL_with_R_naught = read.csv(file = paste0("../Generated_Data/Profiles/", model_name, -->
<!--                                                      "_Model/combined_", model_name, "_bio_good_2_LL_param_list.csv")) -->
<!-- A_7_MLE_R_naught_act = MLE_with_R_naught_act$R_naught -->
<!-- A_7_min_R_naught_act = min(bio_good_2_LL_with_R_naught$R_naught) -->
<!-- A_7_max_R_naught_act = max(bio_good_2_LL_with_R_naught$R_naught) -->

<!-- A_7_bio_good_2_LL = read.csv(paste0("../Generated_Data/Profiles/", model_name, "_Model/",model_name, "_Model_BP_top_2_LL_all_params_bio_good_2_LL.csv")) -->

<!-- A_7_bio_good_2_LL$R_naught_theo = A_7_bio_good_2_LL$Beta_0/(A_7_bio_good_2_LL$gamma + A_7_bio_good_2_LL$mu_H) -->

<!-- head(A_7_bio_good_2_LL) -->
<!-- A_7_bio_good_2_LL$nearest_skip_rho = 0 -->
<!-- A_7_bio_good_2_LL$nearest_skip_R_naught = 0 -->
<!-- A_7_bio_good_2_LL$nearest_skip_delta = 0 -->
<!-- A_7_bio_good_2_LL$skips = -1 -->
<!-- #single_param_data$nearest_skip_R_naught_index = NA -->
<!-- A_7_bio_good_2_LL$nearest_skip_delta_index = NA -->
<!-- A_7_bio_good_2_LL$nearest_skip_rho_index = NA -->
<!-- for(param_index in seq(1, nrow(A_7_bio_good_2_LL))){ -->
<!--   load("../Generated_Data/Skip_Data/nCritics_detailedRepRate_From2to5.Rdata") -->
<!--   head(nCritics_detailedRepRate_From2to5) -->
<!--   row.names(nCritics_detailedRepRate_From2to5) -->
<!--   colnames(nCritics_detailedRepRate_From2to5) -->

<!--   dim(nCritics) #18 (Reporitng rate) x 11 (delta) x 491 (R_0 value) -->
<!--   # Row name: Reporting rate (18 from 1% to 50%) -->


<!--   rep_rate_header_det = str_split(row.names( -->
<!--     nCritics_detailedRepRate_From2to5), pattern = "%", n = Inf, -->
<!--                               simplify = TRUE) -->
<!--   delta_col_header_det = str_split(colnames( -->
<!--     nCritics_detailedRepRate_From2to5), pattern = "_", n = Inf, -->
<!--                                simplify = TRUE) -->
<!--   reporting_rate_det = as.numeric(rep_rate_header_det[,2])/100 -->
<!--   delta_val_det = as.numeric(delta_col_header_det[,2]) -->

<!--   #10% Reporitng Rates -->
<!--   ten_percent_rho_index_det = which(reporting_rate == .10) -->
<!--   four_percent_rho_index = which(reporting_rate == .04) -->
<!--   three_percent_rho_index = which(reporting_rate == .03) -->



<!--   R_0_col_header_det = str_split(names( -->
<!--     nCritics_detailedRepRate_From2to5[1,1,]), pattern = "_", n = Inf, -->
<!--                              simplify = TRUE) -->
<!--   R_0_skip_val_det = as.numeric(R_0_col_header_det[,2]) -->


<!--   #single_param_data = A_7_bio_good_2_LL[param_index,] -->
<!--   #Get R_naught ref on skip plot -->
<!--   A_7_bio_good_2_LL$nearest_skip_R_naught_index[param_index] = -->
<!--     which.min(abs(R_0_skip_val_det - -->
<!--                     A_7_bio_good_2_LL$R_naught_theo[param_index] )) -->
<!--   A_7_bio_good_2_LL$nearest_skip_R_naught[param_index] = -->
<!--     R_0_skip_val_det[ -->
<!--       A_7_bio_good_2_LL$nearest_skip_R_naught_index[param_index]] -->
<!--   #Get rho ref on skip plot -->

<!--   A_7_bio_good_2_LL$nearest_skip_rho_index[param_index] = -->
<!--     which.min(abs(reporting_rate_det - -->
<!--                     A_7_bio_good_2_LL$rho[param_index] )) -->
<!--   A_7_bio_good_2_LL$nearest_skip_rho[param_index] = -->
<!--     reporting_rate_det[ -->
<!--       A_7_bio_good_2_LL$nearest_skip_rho_index[param_index]] -->

<!--   #Get delta ref on skip plot -->
<!--   A_7_bio_good_2_LL$nearest_skip_delta_index[param_index] = -->
<!--     which.min(abs(delta_val_det -A_7_bio_good_2_LL$delta[param_index] )) -->
<!--   A_7_bio_good_2_LL$nearest_skip_delta[param_index] = -->
<!--     delta_val[ -->
<!--       A_7_bio_good_2_LL$nearest_skip_delta_index[param_index]] -->
<!--   A_7_bio_good_2_LL$skips[param_index] = -->
<!--     nCritics_detailedRepRate_From2to5[ -->
<!--       A_7_bio_good_2_LL$nearest_skip_rho_index[param_index], -->
<!--       A_7_bio_good_2_LL$nearest_skip_delta_index[param_index], -->
<!--       A_7_bio_good_2_LL$nearest_skip_R_naught_index[param_index]] -->
<!-- } -->

<!-- p = ggplot(data = A_7_bio_good_2_LL, aes(x = R_naught_theo, -->
<!--                                          y = skips)) + geom_point() + -->
<!--   rahul_theme -->
<!-- p -->

<!-- relevant_skip_plot_data = dplyr::select(A_7_bio_good_2_LL, -->
<!--                                         "R[0]" = nearest_skip_R_naught, -->
<!--                                         skips, -->
<!--                                         rho = nearest_skip_rho, -->
<!--                                         delta = nearest_skip_delta) -->
<!-- min(A_7_bio_good_2_LL$skips, na.rm = TRUE) -->

<!-- relevant_skip_plot_data_melt = melt( -->
<!--   relevant_skip_plot_data, id.vars = c("skips")) -->
<!-- relevant_skip_plot_data_melt$value = signif( -->
<!--   relevant_skip_plot_data_melt$value, digits = 3) -->
<!-- relevant_skip_plot_data_melt$skip_category = cut( -->
<!--   relevant_skip_plot_data_melt$skips,breaks = c(0,1,100,101), -->
<!--   include.lowest = TRUE) -->
<!-- p = ggplot(data = relevant_skip_plot_data_melt, -->
<!--            aes(x = value, y = skips)) + geom_point(size = 2) + -->
<!--   rahul_theme + -->
<!--   xlab("Parameter Value") + -->
<!--   ylab("Number of skips \n (Deterministic) ") + -->
<!--   theme_white_background + -->
<!--   facet_grid(cols = vars(variable), -->
<!--              scales = "free", -->
<!--              labeller = label_parsed) + -->
<!--   theme(panel.spacing = unit(2, "lines")) + -->
<!--   theme(strip.text  = element_text(size = 12, -->
<!--                                    face = "bold", -->
<!--                                    color = "black")) -->
<!-- p = p + theme(axis.text.x = element_text(size = 16)) -->
<!-- p -->
<!-- scaleFUN <- function(x) sprintf("%.2f", x) -->
<!-- p = p + scale_x_continuous(labels=scaleFUN) + aes(color = -->
<!--                                                     skip_category) + -->
<!--   scale_color_manual(values = c("black","red"), -->
<!--                      labels = c("1-100 ", -->
<!--                                 "> 100 "), -->
<!--                      name = c("Number \n of Skips")) -->
<!-- p -->
<!-- range(A_7_bio_good_2_LL$rho) -->

<!-- relevant_skip_plot_data$r0 = -->
<!--   relevant_skip_plot_data$`R[0]` -->


<!-- relevant_skip_plot_data$rho = as.factor(as.character(relevant_skip_plot_data$rho)) -->
<!-- relevant_skip_plot_data_delta_07 = filter( -->
<!--   relevant_skip_plot_data, delta == 0.7) -->


<!-- #relevant_skip_plot_data_delta_07$Type = "Fitted" -->

<!-- skip_plot_data_comb = join( -->
<!--   relevant_skip_plot_data_delta_07,only_delta_07) -->

<!-- p = ggplot(data = only_delta_07, aes(x = r0, y = Num_Skips, -->
<!--                                      color = rho)) + -->
<!--   geom_point(size = 3) + -->
<!--   rahul_theme + -->
<!--   theme_white_background + scale_color_viridis_d(direction = -1)+ -->
<!--   ylab("Number of skips")  + labs(x = expression(R[0])) + -->
<!--   labs(color = expression(rho))+ -->
<!--   rahul_man_figure_theme -->
<!-- p -->

<!-- Fig_2_B = ggplot(data = only_delta_07) + geom_point(data = only_delta_07, -->
<!--                           aes(x = r0, y = Num_Skips, -->
<!--                               color = rho),size = 3 )+ -->
<!--   labs(color = expression(rho))+ -->
<!--   geom_point(data = relevant_skip_plot_data_delta_07, -->
<!--              aes(x = r0, y = skips), -->
<!--              color = 'red', size = 3, -->
<!--              shape =  "circle open") + -->
<!--   rahul_theme + -->
<!--   theme_white_background + scale_color_viridis_d(direction = -1)+ -->
<!--   labs(x = expression(R[0])) + -->
<!--   labs(y = expression(n[c])) + -->
<!--   labs(y = expression(paste("Number of skips (", n[c], ")"))) -->
<!--   labs(color = expression(rho))+ -->
<!--   rahul_man_figure_theme -->
<!-- Fig_2_B -->

<!-- tiff( -->
<!--   paste0( -->
<!--     "../Figures/Manuscript_Figures/TIFF_Files/Fig2B.tiff"), -->
<!--   height = 5, width = 10, res = 300, units = "in") -->
<!-- print(Fig_2_B) -->
<!-- dev.off() -->




<!-- ``` -->

<!-- <!-- ### Supplemental Figure S17 --> -->
<!-- <!-- ```{r} --> -->
<!-- <!-- Sup_Fig_S17 = ggplot() + --> -->
<!-- <!--   geom_point(data = relevant_skip_plot_data, --> -->
<!-- <!--              aes(x = r0, y = skips), --> -->
<!-- <!--              color = 'red', size = 4, --> -->
<!-- <!--              shape =  "cross") + --> -->
<!-- <!--   rahul_theme + --> -->
<!-- <!--   theme_white_background + scale_color_viridis_d(direction = -1)+ --> -->
<!-- <!--   ylab("Number of skips")  + labs(x = expression(R[0])) + --> -->
<!-- <!--   labs(color = expression(rho))+ --> -->
<!-- <!--   rahul_man_figure_theme  --> -->
<!-- <!-- Sup_Fig_S17 --> -->
<!-- <!-- pdf("../Figures/Supplemental_Figures/Supplemental_Figure_17/Supplemental_Figure_S_17.pdf") --> -->
<!-- <!-- print(Sup_Fig_S17) --> -->
<!-- <!-- dev.off() --> -->
<!-- <!-- ``` --> -->

## TIFF Figure 2_A Revised
```{r}
# TIFF Figure 2_A -----------------------------------------------------------


rahul_poster_theme = theme(
  axis.title.x = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  axis.text.x = element_text(size = 21,
                             face = "bold",
                             color = "black"),
  axis.title.y = element_text(size = 23,
                              face = "bold",
                              color = "black"),
  legend.title = element_text(size = 21,
                              face = "bold",
                              color = "black"),
  legend.text = element_text(size = 23,
                             face = "bold",
                             color = "black"),
  axis.text.y = element_text(size = 21,
                             face = "bold",
                             color = "black")
)

Rio_data_clean = read.csv("../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv")
head(Rio_data_clean)
Rio_clean_data = Rio_data_clean
t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01"))
Rio_data_first_three_years_only = filter(Rio_data_clean, times < 365*4)


#add_a_week = Rio_city_DENV1_clean$Date %m+% weeks(1)
#last_day_of_month = add_a_month - 1






# Data plot
load(file = "../Down_Data/denguerj1986-1996.RData")

Rio_city_DENV1_clean = data.frame(Y = as.matrix(dengue.ts),
                                  Date = as.Date(as.yearmon(time(dengue.ts))))
Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date >= "1986-05-01")
Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date <= "1995-12-31")

Rio_city_DENV1_clean$Year = year(Rio_city_DENV1_clean$Date)

serotype_year_map = data.frame(
  Serotype = factor(c(rep("DENV1", 5), rep("DENV1 or \n DENV2",6)),
                    levels = c("DENV1",
                               "DENV2",
                               "DENV1 or \n DENV2")),
  Year = seq(from = 1986, to = 1996, by = 1))
Rio_city_dengue_86_to_96 = filter(Rio_city_DENV1_clean, Date < "1997-01-01")
dengue_data_with_serotype = join(Rio_city_dengue_86_to_96,
                                 serotype_year_map)
dengue_data_with_serotype$Scale = rep("Observed Monthly Cases",
                                      nrow(dengue_data_with_serotype))
dengue_data_with_serotype$Scale_index = rep(1, nrow(dengue_data_with_serotype))
dengue_data_with_serotype$Serotype = as.factor(dengue_data_with_serotype$Serotype)
dengue_data_with_serotype$Serotype =
  ordered(dengue_data_with_serotype$Serotype,
          levels = c( "DENV1","DENV1 or \n DENV2"
          ))

dengue_data_with_serotype$Serotype <- factor(dengue_data_with_serotype$Serotype, levels = c("DENV1 or \n DENV2",
                                               "DENV1",
                                               "DENV2"
))


#dengue_data_with_serotype$Rect_max = dengue_data_with_serotype$Y
dengue_data_with_serotype$Rect_max = 12500

dengue_data_with_serotype$Rect_min = 0
dengue_data_with_serotype$Spark_Rect_max = 8000
dengue_data_with_serotype$Spark_Rect_min = 4000

log_dengue_data_with_serotype = data.frame(
  Date = dengue_data_with_serotype$Date,
  Year = dengue_data_with_serotype$Year,
  Serotype = dengue_data_with_serotype$Serotype,
  Y = log(dengue_data_with_serotype$Y),
  Scale = rep("log(Observed Monthly Cases)", nrow(dengue_data_with_serotype)),
  Scale_index = rep(2, nrow(dengue_data_with_serotype))
)
#log_dengue_data_with_serotype$Rect_max =  log_dengue_data_with_serotype$Y
log_dengue_data_with_serotype$Rect_max =  10
log_dengue_data_with_serotype$Rect_min = 0.0
log_dengue_data_with_serotype$Spark_Rect_max = 7.5
log_dengue_data_with_serotype$Spark_Rect_min = 2.5

dengue_data_both_scales = rbind(dengue_data_with_serotype,
                                log_dengue_data_with_serotype)
#dengue_data_both_scales$Scale = relevel(c("Observed Monthly Cases",
#                                          "log(Observed Monthly Cases)"))
s_0_calc_point = as.Date("1987-9-01")
dengue_data_with_serotype$Rect_max_x = as.Date("1988-07-01")
dengue_data_with_serotype$Rect_min_x = as.Date("1986-05-01")

dengue_data_both_scales$spark_start_date = as.Date("1990-01-01")
dengue_data_both_scales$spark_end_date = as.Date("1990-01-31")

Fig_2_A = ggplot(data = dengue_data_with_serotype,
               aes(x = Date, y = Y))+
  geom_rect(aes(xmin = as.Date(Rect_max_x),
                xmax = as.Date(Rect_min_x),ymin = Rect_min,
                ymax = Rect_max), fill = 'grey70', alpha = 0.9) +
  geom_line() +
  geom_point(size = 3) + rahul_poster_theme +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())+
  theme(legend.position = c(.75,.87)) + xlab("Date") +
  ylab("Observed \n Monthly Cases") +
  theme(axis.title.y = element_text(size = 20,
                                    face = "bold",
                                    color = "black"),
        legend.text = element_text(size = 18,
                                   face = "bold",
                                   color = "black"),
        legend.title = element_text(size = 21,
                                    face = "bold",
                                    color = "black"),
        legend.background = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank()) + rahul_man_figure_theme 
Fig_2_A


tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig2_A.tiff"),
  height = 5, width = 10, res = 300, units = "in")
print(Fig_2_A)
dev.off()

Fig_2_B_mod = Fig_2_B +
  theme(legend.position = c(.50, .75))


tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig2_raw.tiff"),
  height = 5, width = 10, res = 300, units = "in")
print(grid.arrange(Fig_2_A, Fig_2_B_mod, ncol = 2))
dev.off()



```




<!-- ### Old TIFF Figure 2_A -->
<!-- ```{r} -->
<!-- # TIFF Figure 2_A ----------------------------------------------------------- -->


<!-- rahul_poster_theme = theme( -->
<!--   axis.title.x = element_text(size = 23, -->
<!--                               face = "bold", -->
<!--                               color = "black"), -->
<!--   axis.text.x = element_text(size = 21, -->
<!--                              face = "bold", -->
<!--                              color = "black"), -->
<!--   axis.title.y = element_text(size = 23, -->
<!--                               face = "bold", -->
<!--                               color = "black"), -->
<!--   legend.title = element_text(size = 21, -->
<!--                               face = "bold", -->
<!--                               color = "black"), -->
<!--   legend.text = element_text(size = 23, -->
<!--                              face = "bold", -->
<!--                              color = "black"), -->
<!--   axis.text.y = element_text(size = 21, -->
<!--                              face = "bold", -->
<!--                              color = "black") -->
<!-- ) -->

<!-- Rio_data_clean = read.csv("../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv") -->
<!-- head(Rio_data_clean) -->
<!-- Rio_clean_data = Rio_data_clean -->
<!-- t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01")) -->
<!-- Rio_data_first_three_years_only = filter(Rio_data_clean, times < 365*4) -->


<!-- #add_a_week = Rio_city_DENV1_clean$Date %m+% weeks(1) -->
<!-- #last_day_of_month = add_a_month - 1 -->






<!-- # Data plot -->
<!-- load(file = "../Down_Data/denguerj1986-1996.RData") -->

<!-- Rio_city_DENV1_clean = data.frame(Y = as.matrix(dengue.ts), -->
<!--                                   Date = as.Date(as.yearmon(time(dengue.ts)))) -->
<!-- Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date >= "1986-05-01") -->
<!-- Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date <= "1995-12-31") -->

<!-- Rio_city_DENV1_clean$Year = year(Rio_city_DENV1_clean$Date) -->

<!-- serotype_year_map = data.frame( -->
<!--   Serotype = factor(c(rep("DENV1", 5), rep("DENV1 or \n DENV2",6)), -->
<!--                     levels = c("DENV1", -->
<!--                                "DENV2", -->
<!--                                "DENV1 or \n DENV2")), -->
<!--   Year = seq(from = 1986, to = 1996, by = 1)) -->
<!-- Rio_city_dengue_86_to_96 = filter(Rio_city_DENV1_clean, Date < "1997-01-01") -->
<!-- dengue_data_with_serotype = join(Rio_city_dengue_86_to_96, -->
<!--                                  serotype_year_map) -->
<!-- dengue_data_with_serotype$Scale = rep("Observed Monthly Cases", -->
<!--                                       nrow(dengue_data_with_serotype)) -->
<!-- dengue_data_with_serotype$Scale_index = rep(1, nrow(dengue_data_with_serotype)) -->
<!-- dengue_data_with_serotype$Serotype = as.factor(dengue_data_with_serotype$Serotype) -->
<!-- dengue_data_with_serotype$Serotype = -->
<!--   ordered(dengue_data_with_serotype$Serotype, -->
<!--           levels = c( "DENV1","DENV1 or \n DENV2" -->
<!--           )) -->

<!-- dengue_data_with_serotype$Serotype <- factor(dengue_data_with_serotype$Serotype, levels = c("DENV1 or \n DENV2", -->
<!--                                                "DENV1", -->
<!--                                                "DENV2" -->
<!-- )) -->


<!-- #dengue_data_with_serotype$Rect_max = dengue_data_with_serotype$Y -->
<!-- dengue_data_with_serotype$Rect_max = 12500 -->

<!-- dengue_data_with_serotype$Rect_min = 0 -->
<!-- dengue_data_with_serotype$Spark_Rect_max = 8000 -->
<!-- dengue_data_with_serotype$Spark_Rect_min = 4000 -->

<!-- log_dengue_data_with_serotype = data.frame( -->
<!--   Date = dengue_data_with_serotype$Date, -->
<!--   Year = dengue_data_with_serotype$Year, -->
<!--   Serotype = dengue_data_with_serotype$Serotype, -->
<!--   Y = log(dengue_data_with_serotype$Y), -->
<!--   Scale = rep("log(Observed Monthly Cases)", nrow(dengue_data_with_serotype)), -->
<!--   Scale_index = rep(2, nrow(dengue_data_with_serotype)) -->
<!-- ) -->
<!-- #log_dengue_data_with_serotype$Rect_max =  log_dengue_data_with_serotype$Y -->
<!-- log_dengue_data_with_serotype$Rect_max =  10 -->
<!-- log_dengue_data_with_serotype$Rect_min = 0.0 -->
<!-- log_dengue_data_with_serotype$Spark_Rect_max = 7.5 -->
<!-- log_dengue_data_with_serotype$Spark_Rect_min = 2.5 -->

<!-- dengue_data_both_scales = rbind(dengue_data_with_serotype, -->
<!--                                 log_dengue_data_with_serotype) -->
<!-- #dengue_data_both_scales$Scale = relevel(c("Observed Monthly Cases", -->
<!-- #                                          "log(Observed Monthly Cases)")) -->
<!-- s_0_calc_point = as.Date("1987-9-01") -->
<!-- dengue_data_both_scales$Rect_max_x = as.Date("1988-07-01") -->
<!-- dengue_data_both_scales$Rect_min_x = as.Date("1986-05-01") -->
<!-- dengue_data_both_scales$Rect_max_re_emerge_x = as.Date("1990-01-01") -->
<!-- dengue_data_both_scales$Rect_min_re_emerge_x = as.Date("1991-01-01") -->
<!-- dengue_data_both_scales$spark_start_date = as.Date("1990-01-01") -->
<!-- dengue_data_both_scales$spark_end_date = as.Date("1990-01-31") -->

<!-- Fig_2_A = ggplot(data = dengue_data_both_scales, -->
<!--                aes(x = Date, y = Y))+ -->
<!--   geom_rect(aes(xmin = as.Date(Rect_max_x), -->
<!--                 xmax = as.Date(Rect_min_x),ymin = Rect_min, -->
<!--                 ymax = Rect_max), fill = 'skyblue', alpha = 0.9) + -->
<!--   geom_rect(aes(xmin = as.Date(Rect_max_re_emerge_x), -->
<!--                 xmax = as.Date(Rect_min_re_emerge_x),ymin = Rect_min, -->
<!--                 ymax = Rect_max), fill = 'springgreen', alpha = 0.9)+ -->
<!--   geom_rect(aes(xmin = as.Date(spark_start_date), -->
<!--                 xmax = as.Date(spark_end_date),ymin = Rect_min, -->
<!--                 ymax = Spark_Rect_max), fill = 'lightpink', alpha = 0.9)+ -->
<!--   geom_line(aes(color = Serotype)) + -->
<!--   geom_point(aes(color = Serotype), size = 3) + rahul_poster_theme + -->
<!--   theme(axis.line = element_line(colour = "black"), -->
<!--         panel.grid.major = element_blank(), -->
<!--         panel.grid.minor = element_blank(), -->
<!--         panel.border = element_blank(), -->
<!--         panel.background = element_blank())+ -->
<!--   theme(legend.position = c(.75,.87)) + xlab("Date") + -->
<!--   ylab("log(Observed           Observed \n Monthly Cases)    Monthly Cases") + -->
<!--   scale_color_manual(name = "Serotype", values = c("blue","red","darkgreen"))+ -->
<!--   facet_wrap(~Scale_index, ncol = 1, scales = "free_y") + -->
<!--   theme(axis.title.y = element_text(size = 20, -->
<!--                                     face = "bold", -->
<!--                                     color = "black"), -->
<!--         legend.text = element_text(size = 18, -->
<!--                                    face = "bold", -->
<!--                                    color = "black"), -->
<!--         legend.title = element_text(size = 21, -->
<!--                                     face = "bold", -->
<!--                                     color = "black"), -->
<!--         legend.background = element_blank(), -->
<!--         strip.background = element_blank(), -->
<!--         strip.text.x = element_blank()) + rahul_man_figure_theme + -->
<!--   geom_vline(xintercept = s_0_calc_point, color = 'red', -->
<!--              size = 2, linetype = 2) -->
<!-- Fig_2_A -->


<!-- tiff( -->
<!--   paste0( -->
<!--     "../Figures/Manuscript_Figures/TIFF_Files/Fig2_A.tiff"), -->
<!--   height = 5, width = 10, res = 300, units = "in") -->
<!-- print(Fig_2_A) -->
<!-- dev.off() -->

<!-- Fig_2_B_mod = Fig_2_B + -->
<!--   theme(legend.position = c(.50, .75)) -->


<!-- tiff( -->
<!--   paste0( -->
<!--     "../Figures/Manuscript_Figures/TIFF_Files/Fig2_raw.tiff"), -->
<!--   height = 5, width = 10, res = 300, units = "in") -->
<!-- print(grid.arrange(Fig_2_A, Fig_2_B_mod, ncol = 2)) -->
<!-- dev.off() -->



<!-- ``` -->


<!-- <!-- ## TIFF Figure 1 --> -->
<!-- <!-- ```{r} --> -->
<!-- <!-- # TIFF Figure 1 ----------------------------------------------------------- --> -->
<!-- <!-- source("TIFF_Man_Fig_1.R") --> -->

<!-- <!-- ``` --> -->

<!-- <!-- ```{r, cache=FALSE} --> -->

<!-- <!-- knitr::read_chunk('TIFF_Man_Fig_1.R') --> -->
<!-- <!-- ``` --> -->


# Re-emergence analysis via forward simulation
## Simulate re-emergence outbreak in 1991
The following code was run in parallel on a computer cluster:


```{r, cache=FALSE}
knitr::read_chunk('Man_Fig_4_gardner_top_2_LL_Model_A_7.R')
```

### Script for running code on computer cluster (uchicago BSD Gardner)




```{r engine='bash', comment=''}

#knitr::read_chunk('A_7_Man_Fig_4_re_emerge_calc.pbs')
cat A_7_Man_Fig_4_re_emerge_calc.pbs

```

## Collect output
```{r, results = 'hide'}
rm(list = ls())
source("load_libraries_essential.R")
library(zoo)
library(pomp)
source("rahul_theme.R")
args = commandArgs(trailingOnly = TRUE)

#model_name = as.character(args[1])
model_name = "A_7"
print(model_name)

Rio_data_clean = read.csv("../Generated_Data/Rio_DENV1_Data_2_25_years_clean.csv")
head(Rio_data_clean)
Rio_clean_data = Rio_data_clean
t0 = as.numeric(as.Date("1986/05/01") - as.Date("1986/01/01"))
load(file = "../Down_Data/denguerj1986-1996.RData")
Rio_city_DENV1_clean = data.frame(Y = as.matrix(dengue.ts),
                                  Date = as.Date(as.yearmon(time(dengue.ts))))
Rio_city_DENV1_clean = filter(Rio_city_DENV1_clean, Date >= "1986-05-01")

head(Rio_city_DENV1_clean)
Rio_city_DENV1_clean$Date = Rio_city_DENV1_clean$Date %m+% months(1)
#add_a_week = Rio_city_DENV1_clean$Date %m+% weeks(1)
#last_day_of_month = add_a_month - 1


head(Rio_city_DENV1_clean)


Population_Rio_2000 = 5857904 #Census
Population_Rio_1991 = 5480768# Census:
Two_hour_segments_in_year = 365 * 12
time_between_census_dates = 2000 * 365 - 1991 * 365
human_pop_growth_rate = (1 / time_between_census_dates) *
  log(Population_Rio_2000 / Population_Rio_1991)
human_pop_growth_rate

#Source Csnippets
source(file = "Csnippet_SIR_cosine_model.R")


all_combos = read.csv(
  paste0("../Generated_Data/Profiles/", model_name,
         "_Model/combined_",model_name,
         "_profile_data_directory_with_mean_R_0.csv"))

MLE_params = filter(all_combos, LL == max(LL))

bio_good_2_LL = filter(all_combos, LL > max(all_combos$LL) - 2 )

within_20_LL = filter(all_combos, LL > max(all_combos$LL) - 20 )
test_param_index = 1
single_test_subset_output = read.csv(
  paste0(
    "../Generated_Data/Profiles/",
    model_name,
    "_Model/stoch_re_emerge_test/",
    model_name,
    "_re_mergence_spark_probability_data_subset_", test_param_index,
    ".csv"
  ))
all_param_spark_data = data.frame(matrix(nrow = 0, ncol = ncol(single_test_subset_output)))
colnames(all_param_spark_data) = colnames(single_test_subset_output)
head(all_param_spark_data)
num_param_combinations = 457
for(param_index in c(seq(1:23),seq(from = 25,to = 168),seq(from = 170,to = 450),
                     seq(from = 452, to = num_param_combinations))){
  #param_index = as.numeric(Sys.getenv("MOAB_JOBARRAYINDEX"))
  print("param_index")
  print(param_index)
  gardner_max_jobs = 500
  group_size = ceiling(nrow(bio_good_2_LL) / gardner_max_jobs)
  start_index = (param_index - 1) * group_size + 1
  end_index = param_index * group_size
  Num_mif_runs_per_start = 5
  param_data_subset = bio_good_2_LL[start_index:end_index, ]
  
  single_subset_output = read.csv(
    paste0(
      "../Generated_Data/Profiles/",
      model_name,
      "_Model/stoch_re_emerge_test/",
      model_name,
      "_re_mergence_spark_probability_data_subset_", param_index,
      ".csv"
    ))
  if(sum(is.na(single_subset_output$total_re_emergence_prob_1_year)) > 0) {
    print(paste0("Param set fail at ", param_index))
  }
  
  all_param_spark_data = rbind(all_param_spark_data, single_subset_output)
  
}

## Save data (FILE IS LARGE SO COMMENTED OUT)
# write.csv(all_param_spark_data, file = paste0("../Generated_Data/Profiles/",
#           model_name,
#           "_Model/stoch_re_emerge_test/",
#           model_name,
#           "_re_mergence_spark_prob_all_params.csv"
# ))
```

# Plot Figure 4
```{r}
spark_data_90_only = filter(all_param_spark_data, spark_year == 1990)

spark_90_size_20 = filter(spark_data_90_only, spark_size == 20)
no_na_20 = na.omit(spark_90_size_20)
p = ggplot(data = no_na_20,
           aes(x =R_naught, y =  total_re_emergence_prob_1_year)) + geom_point() +
  rahul_theme+ theme_white_background
#p

ML_df = MLE_params
ML_df$r = unique(no_na_20$r)
ML_with_re_emerge_prob = join(ML_df, no_na_20)
p = ggplot(data = no_na_20,
           aes(x =sigma_P, y = total_re_emergence_prob_1_year)) + geom_point(size = 3) +
  rahul_theme + theme_white_background + xlab(expression(sigma[P])) + ylab("Re-Emergence \n Probability in 1990") +
  rahul_man_figure_theme +
  geom_point(data = ML_with_re_emerge_prob,
             aes(x = sigma_P, y = total_re_emergence_prob_1_year),
             color = 'red', fill = "NA", size = 5, shape = 21, stroke = 3)
  
#p


tiff(
  paste0(
    "../Figures/Manuscript_Figures/TIFF_Files/Fig4.tiff"),
  height = 5, width = 10, res = 300, units = "in")
print(p)
dev.off()
```

